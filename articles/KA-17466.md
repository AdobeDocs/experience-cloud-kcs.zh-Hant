---
title: '"AEM 6.x |效能調整秘訣」'
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager 6.4,Experience Manager 6.5"
keywords: KCS、SQL效能調整、ETL系統
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Zita Rodricks
article-created-date: "5/2/2023 2:56:39 PM"
article-published-by: Nayanika Chakravarty
article-published-date: "5/30/2023 9:31:12 PM"
version-number: 2
article-number: KA-17466
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=23b02088-f9e8-ed11-a7c6-6045bd006704"
source-git-commit: f682c286bc28f42c017ec1fec7221acb9171495d
workflow-type: tm+mt
source-wordcount: '2007'
ht-degree: 1%

---

# AEM 6.x |效能調整秘訣

## 說明 {#description}

<b>環境 </b>
- Adobe Experience Manager 6.4
- Adobe Experience Manager 6.5



<b>問題/症狀</b>
作者編輯內容時回應時間差，或是網站對訪客請求的回應緩慢。

這些效能調校秘訣有助於加快查詢和效能。


<b>原因</b>
下列因素會影響AEM中的效能問題：

- 設計錯誤
- 應用程式程式碼
- 缺少快取
- 磁碟I/O設定錯誤
- 記憶體大小
- 網路頻寬和延遲
- 在某些特定的windows 2008和2012版本上安裝AEM，其中記憶體管理是一個問題
- 修改現成可用的設定（如下所述）有助於改善AEM中的效能。



## 解決方法 {#resolution}


<b>防止效能問題</b>

以下是您可以採取的一些步驟，以確保您在效能問題對使用者造成影響之前發現並修正這些問題：

1. 實作和執行負載測試，以模擬製作和發佈執行個體中的真實情境。 研究和定義預期負載是這個過程中的關鍵步驟。 此步驟可協助您示範AEM應用程式、架構和AEM安裝一旦在生產環境中上線，是否會有良好的效能。\
   本練習的結果有助於判斷是否有組態錯誤、應用程式問題、大小調整、硬體問題，或其他影響系統效能的問題。 另請參閱 [效能准則](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/configuring/performance-guidelines.html?lang=en) 和 [監視准則](https://helpx.adobe.com/experience-manager/kb/how-to-monitor-the-tarmk.html).
2. 除了負載測試，壓力測試有助於定義系統可處理的最大負載。 此測試可協助您為流量尖峰做好準備。 有關效能測試的更多資訊可以找到 [此處](https://experienceleague.adobe.com/docs/experience-manager-64/deploying/practices/best-practices.html).
3. 安裝建議的AEM Service Pack、Cumulative Fix Pack和Hotfix： [Adobe Experience Manager版本更新](https://experienceleague.adobe.com/docs/experience-manager-release-information/aem-release-updates/aem-releases-updates.html?lang=zh-Hant).
4. 如果您使用的是Windows伺服器，請檢閱 [本文](https://helpx.adobe.com/experience-manager/kb/high-memory-usage-aem-6.html).
5. 如果您計畫將大量資產（影像、影片等）載入到AEM中，請務必套用 [Assets最佳實務](https://experienceleague.adobe.com/docs/experience-manager-65/assets/best-practices-for-assets.html?lang=en).
6. 提供足夠的RAM並避免IO飽和\
   如果您打算在任何規模上執行生產，則Linux環境應布建的RAM數量應該與區段tar檔案在離線壓縮（或線上壓縮尖峰）之間增長到的數量相同。 此外，下列專案可避免IO飽和。

   - 分隔作業系統、資料和記錄磁碟
   - 使用Noatime掛載資料磁碟。
   - 將資料磁碟上的預先讀取緩衝區設為32。
   - 理想情況下，在資料磁碟上使用XFS over ext4。
   - 如果RedHat在VM中執行，請確定平均資訊量集區一律為 `>`  1K位元（必要時使用rngtools）
7. 在Linux上停用透明大型頁面\
   AEM會執行微調的讀取/寫入，而Linux透明大型頁面已針對大型作業最佳化，因此建議您 [停用透明大型頁面](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/introduction/aem-with-mongodb.html?lang=en#operating-system-support) 使用Mongo或Tar儲存時。
8. 啟用暫時性工作流程\
   暫時性工作流程可用於滿足以下條件的任何工作流程：

   - 經常執行。
   - 不需要工作流程歷史記錄。

   在這些情況下，它們可以提升效能。
當有大量資產擷取時，通常符合此使用案例。
請遵循以下說明的程式： [效能調整資產](https://experienceleague.adobe.com/docs/experience-manager-65/assets/administer/performance-tuning-guidelines.html?lang=en).
9. 調整Sling工作佇列\
   大量上傳大型資產通常需要耗費大量資源。 依預設，每個工作佇列的並行執行緒數目等於CPU核心數目。 因此，此值設定可能會導致整體效能影響和高Java棧積消耗。
Adobe建議不要超過50%的CPU核心。 若要調整此值，請前往下列網址： https:/host:port/system/console/configMgr/org.apache.sling.event.jobs.QueueConfiguration Set `queue.maxparallel` 至代表AEM執行個體所在伺服器CPU核心的50%的值。 例如，對於8個CPU核心，將值設定為4。
10. 調整您的Oak存放庫\
   首先，請確定您已為AEM 6執行個體安裝最新的Oak版本。 請檢視上述建議的Hotfix頁面。

   <u>Oak查詢引擎/索引最佳化</u>

   - <b>為所有常用的搜尋查詢建立自訂Oak索引。</b>
      - 如需有關如何分析緩慢查詢的資訊，請參閱此 [文章](https://experienceleague.adobe.com/docs/experience-manager-65/developing/bestpractices/troubleshooting-slow-queries.html?lang=en).
      - 在oak：index節點下建立自訂索引，以搜尋您要搜尋的所有搜尋屬性，方法如下： [文章](https://experienceleague.adobe.com/docs/experience-cloud-kcs/kbarticles/KA-17492.html?lang=zh-Hant).
      - 對於每個自訂Lucene型索引，請嘗試設定includedPaths （字串）設定，以限制索引僅套用至某些內容路徑。 然後將適用的搜尋限製為索引所包含的路徑。
   - <b>JVM引數</b>\
      在AEM啟動指令碼中新增這些JVM引數，以防止擴充查詢造成系統超載。 請注意，這些是從AEM 6.3開始的預設值。

      - Doak.queryLimitInMemory=500000 (另請參閱 [Oak檔案](https://jackrabbit.apache.org/oak/docs/query/query-engine.html#Slow_Queries_and_Read_Limits))
      - Doak.queryLimitReads=100000 (另請參閱 [Oak檔案](https://jackrabbit.apache.org/oak/docs/query/query-engine.html#Slow_Queries_and_Read_Limits))
      - Dupdate.limit=250000 (僅適用於DocumentNodeStore，例如 MongoMK， RDBMK)

      下列選項可能也會改善效能，但會變更結果大小呼叫的意義。 特別是，在計算大小時，只會考量屬於所用索引一部分的查詢限制。
此外，ACL不會套用至結果，所以對目前工作階段不可見的節點仍會包含在傳回的計數中。 因此，傳回的計數可能會高於實際結果數，而準確的計數只能透過逐一檢視結果來決定：

      - Doak.fastQuerySize=true (另請見「結果大小」 [Oak檔案](https://jackrabbit.apache.org/oak/docs/query/query-engine.html#Slow_Queries_and_Read_Limits))

      注意：啟用 *fastQuerySize* 可加快查詢回應。 但是，AEM傳回某些查詢不準確的結果計數。 如果您在應用程式中依賴精確的結果計數，請勿使用 *fastQuerySize*.
   - <b>Lucene索引設定</b>\
      開啟/system/console/configMgr/org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexProviderService和

      - 啟用 <b>CopyonRead</b> (自AEM 6.2起預設為啟用)
      - 啟用 <b>CopyonWrite</b> (自AEM 6.2起預設為啟用)
      - 啟用 <b>預先擷取索引檔案</b> (自AEM 6.2起預設為啟用)

      另請參閱 [http://jackrabbit.apache.org/oak/docs/query/lucene.html](http://jackrabbit.apache.org/oak/docs/query/lucene.html) 如需可用引數的詳細資訊由於有些路徑不需要索引，您可以執行下列動作：在CRXDE Lite中，前往/oak：index/lucene，使用下列值設定名為excludedPaths的多值字串屬性（字串） /var、/etc/workflow/instances、/etc/replication。
   - <b>資料存放區</b>\
      如果您使用AEM Assets或有一個廣泛使用二進位檔案的AEM應用程式，Adobe建議您使用外部資料存放區。 使用外部資料存放區有助於確保最高效能。 另請參閱 [詳細指示檔案](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/deploying/data-store-config.html?lang=en).
使用FileDataStore時，請將cacheSizeInMB調整為可用棧積的百分比。 保守值為最大棧積的2%。 例如，對於8 GB棧積：

      - maxCachedBinarySize=1048576
      - cacheSizeInMB=164

      請注意 *maxCachedBinarySize* 設為1 MB (1048576)。 因此，它只會快取最大1 MB的檔案。 將此設定調整為較小的值可能也有意義。
處理大量二進位檔時，您想要將效能最大化。 因此，Adobe建議使用外部資料存放區，而非預設節點存放區。 此外，Adobe建議您調整下列引數：

      - maxCachedBinarySize=10485760
      - cacheSizeInMB=4096

      注意： *cacheSizeInMB* 若設定得太高，可能會導致Java處理序的記憶體不足。 例如，如果您將棧積大小上限設為8 GB (-Xmx8g)，並且您預期AEM和應用程式會利用4 GB的組合棧積，則將cacheSizeInMB設定為82 （而不是164）是有意義的。 在2-10%的範圍內，最大棧積是安全的設定。 不過，Adobe建議您使用負載測試來驗證設定變更，並同時監控記憶體使用情況。
11. Mongo儲存調整
   - <b>MongoBlobStore快取大小：</b> blobstore是用來儲存和讀取大型二進位物件。 在內部，具有快取的存放區會實作，將二進位檔分割為相對較小的區塊（資料或雜湊程式碼或間接雜湊），以便每個區塊都適合記憶體。         在預設設定中，MongoBlobStore會使用16MB的固定快取大小。 對於有更多RAM可用且經常存取Blob儲存的部署（例如，當Lucene索引較大時），請增加快取大小。 此快取大小僅適用於使用MongoBlobStore （預設）時，而不適用於使用外部blobstore時。

      - 您可以透過上的blobCacheSize設定來設定快取大小(MB) [DocumentNodeStoreService](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/deploying/data-store-config.html?lang=en).<br>              例如： blobCacheSize=1024
      - 也請檢閱AEM-MongoDB [檢查清單](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/introduction/aem-with-mongodb.html?lang=en).
   - <b>檔案快取大小：</b> 若要最佳化從MongoDB讀取節點的效能，您需要調整DocumentNodeStore的快取大小。 快取的預設大小設定為256 MB，這會分散在DocumentNodeStore中使用的各種快取中。         另請參閱 [http://jackrabbit.apache.org/oak/docs/nodestore/documentmk.html#cache](http://jackrabbit.apache.org/oak/docs/nodestore/documentmk.html#cache)

      - 您可以透過DocumentNodeStoreService上的快取設定來設定快取大小(MB)。 例如，cache=2048。
      - 在crx-quickstart/install/org.apache.jackrabbit.oak.plugins.document.DocumentNodeStoreService.configuration中設定下列所有快取設定，然後使用各種值載入測試，以檢視您的環境的最佳設定為何。 請注意，剩餘的快取百分比會指定給檔案快取：
         - cache=2048
         - nodeCachePercentage=35
         - childrenCachePercentage=20
         - diffCachePercentage=30
         - docChildrenCachePercentage=10
      - 在上述設定下，百分比總計為95%。 剩餘5%的快取會提供給documentCache。              documentCache = cache - nodeCache - childrenCache - diffCache - docChildrenCache
      - 分發快取百分比時，請確定documentCache的剩餘快取不是太大。 也就是說，將其限制在最大500 MB以下；大型的documentCache可能會導致執行快取失效所需的時間增加。
   - <b>使用Oak 1.4.x的AEM 6.2中的快取設定：</b>
      - 在AEM 6.2中，已變更這些快取設定的運作方式。 在具有Oak 1.4的AEM 6.2中，有一個新快取：prevDocCache。 您可以使用prevDocCachePercentage設定來設定此快取。 預設值為4。
      - documentCache使用剩餘的快取MB （快取設定減去所有其他快取的大小）： documentCache = cache - nodeCache - childrenCache - diffCache - docChildrenCache - prevDocCache
   - <b>實作MongoDB生產檢查清單：</b>\
      [http://docs.mongodb.org/manual/administration/production-checklist/](http://docs.mongodb.org/manual/administration/production-checklist/)  — 根據Mongo DB支援，許多專案對效能有重大影響。 如有任何問題，請直接聯絡MongoDB支援。
   - <b>讀取效能：</b> 將此查詢字串引數新增至每個AEM節點上的Mongo DB URL：         *？readPreference=secondaryPreferred*
此引數會告訴系統從次要裝置進行讀取，這會提供一些額外的讀取效能。
   - <b>增加Oak觀察的對話串集區：</b> open */system/console/configMgr/org.apache.sling.commons.threads.impl.DefaultThreadPool.factory*        將名稱設定為oak-observation，並將最小和最大集區大小設定為20。
   - <b>增加觀察佇列長度：</b> 建立名為的檔案 *com.adobe.granite.repository.impl.SlingRepositoryManager.cfg* 包含引數 *oak.observation.queue-length=50000*. 將其放在 */crx—quickstart/install* 資料夾。
   - 避免長時間執行查詢：在JVM引數中設定系統屬性： *-Doak.mongo.maxQueryTimeMS=60000* 以避免執行超過1分鐘的查詢。
12. Tar儲存調整\
   微核心不會直接呼叫記憶體對應檔案。 不過，JDK在內部會使用記憶體對應檔案來進行有效讀取。 在某些Windows 64位元作業系統上，可能無法清除記憶體對應的檔案，並消耗所有原生作業系統的記憶體。 請務必安裝來自microsoft的效能相關修補程式/Hotfix (請參閱 [KB 2731284](https://support.microsoft.com/en-us/topic/-33-dos-error-code-when-memory-memory-mapped-files-are-cleaned-by-using-the-flushviewoffile-function-in-windows-7-or-in-windows-server-2008-r2-79fd0431-2898-d6a0-d182-e260e1fc1104))和Oracle。

   另一個選項是透過新增來停用記憶體對應模式 *tarmk.mode=32* 在 [SegmentNodeStoreService.config](https://experienceleague.adobe.com/docs/experience-manager-64/deploying/deploying/data-store-config.html?lang=en) 直到作業系統問題解決為止。 停用的缺點會導致I/O密集化。 請務必提高I/O頁面鎖定限制。
13. TarMK修訂清除（壓縮）\
   從AEM 6.3開始，線上壓縮（也稱為線上修訂清除）預設為啟用。 另請參閱 [此頁面](https://experienceleague.adobe.com/docs/experience-manager-65/deploying/deploying/revision-cleanup.html?lang=en) 以取得詳細資訊。
14. 適用於Adobe Managed Services (AMS)客戶的Cloud Manager\
   [Cloud Manager](https://experienceleague.adobe.com/docs/experience-manager-cloud-manager/content/introduction.html?lang=zh-Hant) （僅限AMS客戶）可讓客戶透過引導式效能測試和自動調整規模，確保成功部署AEM。

