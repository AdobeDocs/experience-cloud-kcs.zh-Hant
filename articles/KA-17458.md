---
title: 最佳化Dispatcher快取
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/20/2021 7:12:29 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 1:45:44 PM
version-number: 1
article-number: KA-17458
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ee6e74a7-d931-ec11-b6e5-000d3a5ba97a
exl-id: 84871fce-d53d-4a1d-aabf-ccf8c8c47810
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '1477'
ht-degree: 1%

---

# 最佳化Dispatcher快取

## 說明


本文著重於AEM Dispatcher中的最新最佳化，以及如何最佳運用這些最佳化。  AEM Dispatcher是快取 [反向代理](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server) 專為搭配Adobe Experience Manager使用而設計的伺服器。  它可以作為模組在現有Web伺服器軟體中安裝和運行。  在撰寫本文時， [dispatcher模組受支援](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-install.html) 在Apache HTTP Server、Microsoft IIS和iPlanet上。


## 解析度

<br><br>Dispatcher快取如何運作<br><br><br><br><br><br>
在最基本的層級，AEM Dispatcher是反向代理，其運作方式是執行快取、快取排清和快取失效。

如需Dispatcher的詳細資訊，請參閱相關連結：

1. [Dispatcher的運作方式及安裝方式](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher.html).
2. [Dispatcher中可用的設定選項](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html).
3. [Dispatcher運作方式的網路研討會](https://github.com/cqsupport/webinar-dispatchercache)  — 請注意，簡報中的某些資訊是以舊版dispatcher為基礎。
4. [Gem網路研討會會議，探討Dispatcher功能、CDN使用方式和安全性](https://docs.adobe.com/ddc/en/gems/dispatcher-caching---new-features-and-optimizations.html).
5. [Gem工作階段，探討Dispatcher中較新的功能（在v4.1.9之後）](https://helpx.adobe.com/experience-manager/kt/eseminars/gems/aem-dispatcher.html).

<br><br><br><br><br><br>最佳化Dispatcher快取<br><br><br><br><br><br>
以下是一些最佳化Dispatcher快取的方式：

1. <b>快取幾乎所有內容</b>  — 這表示使用者會多次請求任何內容，都可快取。
2. <b>針對不同時段快取個人化內容</b>  — 若您的網站有個人化內容，請考慮使用 [Apache Sling Dynamic Includes](https://helpx.adobe.com/experience-manager/kt/platform-repository/using/sling-dynamic-include-technical-video-setup.html) 在AEM應用程式中，以利用Ajax（非同步JavaScript和瀏覽器層級的XML呼叫）、SSI（Web伺服器層級的伺服器端包含）和ESI（CDN層級的邊緣端包含）來快取頁面的不同部分，以維持不同的時間。
3. <b>絕不刪除即時Dispatcher上的Dispatcher快取</b>  — 如果Dispatcher提供即時內容，而您刪除快取，將會導致大量請求傳回AEM。  因此，絕不應在即時Dispatcher上刪除Dispatcher快取。
4. <b>提升快取 </b> — 在刪除調度程式快取之前，請先從負載平衡器中提取調度程式，刪除快取，然後運行Web Crawler工具以快取調度程式上的檔案，然後再將其置於負載平衡器中。
5. <b>快取錯誤頁</b>  — 善用 <b>[DispatcherPassError 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer) </b>（Apache Web Server專用）指令，從Dispatcher快取中提供錯誤頁面，例如404。
6. <b>GZip壓縮所有檔案類型（預壓縮的檔案類型除外） </b> — 在Apache Web伺服器中， [mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) 可以使用，但請確定 <b>變異：User-Agent </b>標題<b> </b>未設定。  在Microsoft IIS中，使用 [動態壓縮](https://docs.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/).

   Apache設定範例（僅指定某些內容類型以避免預先壓縮的檔案類型）:

   AddOutputFilterByType DEFLATE文本/html文本/純文字檔案/xml文本/css文本/css文本/javascript應用程式/javascript
7. <b>啟用 [/serveStaleOnError](https://helpx.adobe.com/experience-manager/kb/ServeStaleContentOnError.html)</b> 在/cache設定中 — 當AEM例項伺服錯誤時，提供舊快取檔案。
8. <b>新增 [/gracePeriod](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> 至/cache設定 — 定義上次內容發佈事件（「啟用」）後，快取仍可提供失效的過時資源的秒數。  這可減少大型內容發佈活動（例如「樹狀檢視啟動」）期間，傳回至發佈例項的請求數。
9. <b>新增規則至 [/ignoreUrlParams](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b>  — 忽略應用程式不需要或使用的查詢字串參數。  這可讓URL快取，即使查詢字串存在亦然。
10. <b>快取控制項和上次修改的響應標頭</b>  — 使用<b> [/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> 快取HTTP回應標題的設定 <b>快取控制</b> 和 <b>上次修改 </b>(和/或 <b>ETag</b> 標題(如果您是從AEM傳送)。  這有助於簡化和最佳化CDN和瀏覽器層級的快取。  快取這些標題可讓僅AEM設定標題，而非Web伺服器本身。  請注意，執行此動作時，您需要開始從AEM應用程式傳送標題。
11. <b>盡可能長時間快取內容</b> 和 <b>減少傳回AEM的請求</b>  — 通過啟用 [重新擷取](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#refetching-flush) 刷新所有刷新代理。  或使用 [<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) 設定 <b>快取控制：max-age=...</b> 盡可能將標頭快取檔案。  請參閱 [low](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) 以取得本主題的詳細資訊。

<br><br><br><br><br><br>使用TTL<br><br><br><br><br><br>
自Dispatcher 4.1.11版起， [/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL) 可在.any檔案設定中設定。  此設定會讓Dispatcher遵循HTTP Cache-Control回應標題中設定的快取有效期。  換言之，Dispatcher的運作方式與CDN類似，當檔案過期時，會發生主要形式的快取失效。  實作此項目並開始傳送後 <b>快取控制：max-age=... </b>針對AEM的所有回應，則您可以在發佈執行個體中安全地停用dispatcher排清代理。

在發佈執行個體上停用排清代理後，您可能仍想要能夠排清Dispatcher快取。  在這種情況下，您可以使用 [ACS Commons - Dispatcher排清UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html).  此工具會安裝在製作執行個體上。  它為使用者提供UI，讓他們可以在其中執行手動快取排清請求。

<b>I.啟用TTL（「存留時間」或過期）樣式無效判定的步驟：</b>

1. 修改AEM應用程式中要傳送的原始碼 <b>快取控制 </b>標題和 <b>上次修改 </b>適用於尚未設定的所有請求。
2. 安裝Dispatcher 4.1.11或更新版本。
3. 設定 <b>[/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> 在網站的.any伺服器陣列設定中。
4. 設定 <b>[/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>快取配置 <b>快取控制</b> 和 <b>上次修改</b> 標題。
5. 重新啟動網頁伺服器。


<b>二。 在發佈執行個體上停用Dispatcher排清代理：</b>

Dispatcher現在會使用「快取控制」標題來控制快取檔案的失效。  因為如此，就不再需要從發佈例項排清調度程式。

1. 前往每個發佈例項上的/etc/replication/agents.publish.html 。
2. 轉到每個刷新代理的配置並禁用代理。


<b>三。 允許來自製作例項的手動Dispatcher排清請求：</b>

現在，由於已禁用刷新代理，因此您完全依賴 <b>快取控制 </b>頁首，以控制dispatcher上何時重新整理內容。  您仍可讓使用者手動清除Dispatcher快取：

1. 安裝 [ACS Commons - Dispatcher排清UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html) 在author例項上。
2. 在製作執行個體上設定排清代理。
3. 在每個代理配置中，設定 <b>觸發器</b> = <b>忽略預設值 </b>選項啟用。 當用戶按一下 <b>（取消）發佈 </b>或 <b>（取消）啟用</b> 在AEM UI中。

<br><br><br><br><br><br>重新擷取Dispatcher排清<br><br><br><br><br><br>
為了最佳化Dispatcher排清請求，所有Dispatcher排清代理都應該有一項名為「已啟用重新擷取排清」的功能。

若要啟用重新擷取Dispatcher排清，請執行下列動作：

1. 前往 <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> 並以管理員身分登入。
2. 從下載套件 [此處](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true).
3. 上傳套件並安裝至套件管理器。
4. 前往您的Dispatcher排清代理程式設定。 例如 <b>/etc/replication/agents.author/flush.html</b>
5. 按一下 <b>編輯</b>
6. 設定下列項目
   - <b>序列化類型</b> = <b>重新擷取Dispatcher排清</b>
   - <b>延伸</b> = <b>HTTP方法</b> = <b>POST</b>
7. 按一下 <b>儲存</b>


請注意，上述安裝的套件只是基本範例。  要自定義並優化重取刷新，可以修改它發送的URI清單。  程式碼為開放原始碼，可找到 [此處](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle).  程式碼會將URI清單新增至請求內文，作為指示Dispatcher要重新擷取的路徑的參數。  您可以根據應用程式需求新增更多路徑，以最佳化網站的快取功能。
<br><br><br><br><br><br>重新提取刷新的更詳細說明<br><br><br><br><br><br>
Dispatcher排清通常可透過刪除檔案來運作：

1. 觸控式.stat檔案
2. 刪除/content/foo。\*
3. 刪除/content/foo/_jcr_content


由於檔案在步驟2中刪除，下次使用者要求/content/foo.html或/content/foo.json之類的檔案時，當檔案「重新擷取」時，對相同檔案的後續要求也會傳送至發佈執行個體，直到快取檔案為止。  若是回應緩慢或流量大的頁面（例如首頁），這可能會導致發佈執行個體層級泛濫。

若要解決此問題，請啟用名為重新擷取的Dispatcher功能。  此功能可讓您傳送URI清單，Dispatcher應主動「重新擷取」並取代，而非刪除。

見22:41-27:05個 [簡報記錄](https://my.adobeconnect.com/p7th2gf8k43) 以取得運作方式及設定方式的示範。
