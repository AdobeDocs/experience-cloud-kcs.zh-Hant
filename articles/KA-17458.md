---
title: 「如何優化Dispatcher快取？」
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS，優化Dispatcher快取AEM,"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Nayanika Chakravarty
article-created-date: "5/23/2023 7:20:55 PM"
article-published-by: Nayanika Chakravarty
article-published-date: "5/23/2023 8:40:51 PM"
version-number: 7
article-number: KA-17458
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=433e47ed-9ef9-ed11-8849-6045bd006b4b"
source-git-commit: 7d249351b2bbbbe47a3b0687d12862d0d0602388
workflow-type: tm+mt
source-wordcount: '1499'
ht-degree: 46%

---

# 如何優化Dispatcher快取？

## 說明 {#description}

<b>環境</b>
Adobe Experience Manager


<b>問題/症狀</b>
本文重點介紹調度器中的最新優AEM化，以及如何最好地利用這些優化。 調度AEM程式是快取 [反向代理](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server) 專供Adobe Experience Manager使用的伺服器。 它可以作為模組在現有Web伺服器軟體中安裝和運行。 在撰寫本文時， [dispatcher模組受支援](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/getting-started/dispatcher-install.html) 在Apache HTTP Server、MicrosoftIIS和iPlanet上。


## 解決方法 {#resolution}


<b>Dispatcher快取如何工作？</b>

在最基本的層面，調度AEM器是反向代理，通過執行快取、快取刷新和快取失效來工作。

如需有關 Dispatcher 的更多詳細資訊，請參閱相關連結：

1. [Dispatcher 運作原理以及如何進行安裝](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/dispatcher.html)。
2. [Dispatcher 中可用的設定選項](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=zh-Hant)。
3. [有關 Dispatcher 運作原理的網路研討會](https://github.com/cqsupport/webinar-dispatchercache)- 請注意，簡報中的某些資訊會根據舊版本的 Dispatcher。
4. [有關 Dispatcher 功能、CDN 使用和安全性的 Gems 網路研討會](https://experienceleague.adobe.com/docs/experience-manager-gems-events/gems/gems2015/aem-dispatcher-caching-new-features-and-optimizations.html)。
5. [有關 Dispatcher 中新功能的 Gems 工作階段 (v4.1.9 之後)](https://experienceleague.adobe.com/docs/experience-manager-gems-events/gems/gems2014/aem-dispatcher.html)。


<u><b>優化Dispatcher快取</b></u>

以下是優化調度程式快取的一些方法：

1. <b>幾乎所有內容都快取</b>  — 這意味著快取用戶將多次請求的任何內容。
2. <b>快取不同時間段的個性化內容</b>  — 如果您的站點具有個性化內容，則考慮使用 [Apache Sling動態包括](https://experienceleague.adobe.com/docs/experience-manager-learn/foundation/development/set-up-sling-dynamic-include.html) 在您的AEM應用程式中，利用Ajax（瀏覽器級別的非同步JavaScript和XML調用）、SSI（Web伺服器級別的伺服器端包括）和ESI（CDN級別的邊緣包括）將頁面的不同部分快取不同時間段。
3. <b>絕不刪除即時 Dispatcher 上的 Dispatcher</b> - 如果 Dispatcher 正在提供即時內容並且您刪除了快取，這將導致大量請求返回 AEM。  因此，絕不應該在即時 Dispatcher 上刪除 Dispatcher 快取。
4. <b>對快取進行質數 </b> — 在刪除調度程式快取之前，請先將調度程式從負載平衡器中拔出，然後刪除快取，然後運行Web Crawler工具以在將其置於負載平衡器上之前快取調度程式上的檔案。
5. <b>快取錯誤頁</b>  — 利用 [DispatcherPassError 1](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer)<b> </b>（特定於Apache Web Server的）指令，用於從調度程式快取中提供錯誤頁（如404s）。
6. <b>GZip壓縮除預壓縮的檔案類型外的所有檔案類型 </b> — 在Apache Web Server中， [mod_defla](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) 可以使用，但要確保 <b>變化：用戶代理 </b>標題<b> </b>未設定。在 Microsoft IIS 中，請使用[動態壓縮](https://learn.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/)。

   Apache配置示例（僅指定某些內容類型以避免預壓縮檔案類型）:

   <b>*AddOutputFilterByType DEFLATE文本/html文本/純文字檔案/xml文本/css文本/javascript應用程式/javascript</b>*
7. <b>啟用 [/serveStaleOnError](https://helpx.adobe.com/tw/experience-manager/kb/ServeStaleContentOnError.html)</b> <b>在/cache配置中</b>  — 當實例服務錯誤時AEM提供舊快取檔案。
8. <b>添加 [/gracePeriod](https://docs.adobe.com/content/help/zh-Hant/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> <b>到/cache配置</b>  — 定義上次內容發佈事件（「激活」）後快取中仍然可以提供失效的自動失效資源的秒數。  這減少了在大型內容發佈活動 (例如「樹啟動」) 期間返回發佈執行個體的請求數量。
9. <b>將規則添加到 [/ignoreUrlParams](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b>  — 忽略應用程式不需要或使用的查詢字串參數。  即使存在查詢字串，這也允許快取 URL。
10. <b>快取快取控制和上次修改的響應標頭</b>  — 使用<b> [/headers](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> 快取HTTP響應標頭的配置 <b>快取控制</b> 和 <b>上次修改時間 </b>(和/或 <b>ETag</b> 標題)AEM。  這有助於在 CDN 和瀏覽器層面簡化和最佳化快取。  快取這些標題使得只有 AEM 可設定標題，網頁伺服器本身則不行。  請注意，執行此操作時，您需要開始從 AEM 應用程式傳送標題。
11. <b>盡可能長地快取內容</b> 和 <b>減少返回的請AEM求</b>  — 通過在所有刷新代理上啟用重取刷新來優化刷新請求。 請參閱下面標題為 *重新獲取Dispatcher刷新*。 或使用 [<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) 設定 <b>快取控制：最大值=...</b> 標題以盡可能長時間快取檔案。  請參閱[下文](https://helpx.adobe.com/tw/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls)以了解有關本主題的詳細資訊。



<u><b>使用TTL</b></u>

從Dispatcher 4.1.11版開始， [/enableTTL 1](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=en#configuring-time-based-cache-invalidation-enablettl) 可以在.any檔案配置中設定。  此設定使HTTP Cache-Control響應標頭中設定的調度程式相關快取過期時間。  換句話說，Dispatcher 的功能將類似 CDN，當檔案到期時會發生主要形式的快取失效。  一旦您實施此操作並開始發送 <b>快取控制：最大值=... </b>對於來自的所AEM有響應，則可以在發佈實例中安全禁用您的dispatcher flush代理。

在發佈執行個體上停用排清代理程式後，您可能仍希望能夠排清 Dispatcher 快取。  在這種情況下，您可以使用 [ACS Commons - Dispatcher Flush UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。  此工具可安裝在作者執行個體上。  它為使用者提供了一個 UI，他們可以在其中執行手動快取排清請求。

<b>I. 啟用 TTL (「存留時間」或有效期) 樣式失效的步驟：</b>

1. 修改要發送的應AEM用程式中的原始碼 <b>快取控制 </b>標題和 <b>上次修改時間 </b>所有尚未設定的請求。
2. 安裝Dispatcher 4.1.11或更高版本。
3. 設定 <b>[/enableTTL 1](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> 在站點的.any場配置中。
4. 設定 <b>[/headers](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>快取的配置 <b>快取控制</b> 和 <b>上次修改時間</b> 標題。
5. 重新啟動網頁伺服器。


<b>II. 在發佈執行個體上停用 Dispatcher Flush 代理程式：</b>

調度程式現在將使用Cache-Control頭來控制快取檔案的無效。  既然是這種情況，則不再需要從發佈執行個體中排清 Dispatcher。

1. 訪問每個發佈實例的/etc/replication/agents.publish.html。
2. 前往每個排清代理程式的設定並停用該代理程式。


<b>III. 允許來自作者執行個體的手動 Dispatcher Flush 請求：</b>

既然已禁用刷新代理，您將完全依賴 <b>快取控制 </b>用於控制何時在調度程式上刷新內容的標題。  您仍然可以允許使用者核發 Dispatcher 快取的手動排清：

1. 在作者執行個體上安裝 [ACS Commons - Dispatcher Flush UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。
2. 在作者執行個體上設定排清代理程式。
3. 在每個代理配置中，設定 <b>觸發器</b> =`>`  <b>忽略預設值 </b>選項。 此選項會使得排清代理程式忽略使用者何時在 AEM UI 中按一下 <b>(取消) 發佈</b>或者<b> (取消) 啟動</b>。


<u><b>重新獲取Dispatcher刷新</b></u>

要優化調度程式刷新請求，所有調度程式刷新代理都應啟用稱為重新讀取刷新的功能。

若要啟用重新擷取 Dispatcher Flush，請執行以下操作：

1. 前往 <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> 並以管理員身分登入。
2. 從[此處](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true)下載套件。
3. 將套件上傳並安裝到封裝管理員。
4. 前往 Dispatcher Flush 代理程式設定。例如 <b>/etc/replication/agents.author/flush.html</b>
5. 按一下<b>編輯</b>。
6. 設定以下內容
   - <b>序列化類型</b> = <b>重新擷取 Dispatcher Flush</b>
   - <b>擴展</b> =`>`  <b>HTTP方法</b> = <b>POST</b>
7. 按一下<b>儲存</b>。


注意 — 上面安裝的軟體包只是一個基本示例。  若要自訂和最佳化重新擷取排清，您可以修改它傳送的 URI 清單。  程式碼是開放原始碼，並可以在[此處](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle)找到。  該程式碼將 URI 清單當成參數新增到請求內文中，告知 Dispatcher 要重新擷取哪些路徑。  您可以根據應用程式要求新增更多路徑，以最佳化網站的快取功能。


<u><b>重取刷新的詳細說明</b></u>

通常，調度程式刷新通過刪除檔案來工作：

1. 觸摸.stat檔案
2. 刪除/content/foo。\*
3. 刪除/content/foo/_jcr_content


由於在步驟2中刪除了檔案，因此，當用戶下次請求/content/foo.html或/content/foo.json等檔案時，當檔案正在「重新獲取」時，隨後對同一檔案的請求也會發送到發佈實例，直到該檔案被快取。  對於緩慢回應或高流量的頁面 (例如首頁頁面)，這可能會導致溢出發佈執行個體層。

若要解決此問題，請啟用 Dispatcher 的一項稱為重新擷取的功能。  此功能允許您傳送 Dispatcher 應主動「重新擷取」並取代而不是刪除的 URI 清單。

如需它如何運作以及如何設定的示範，請參閱 22:41-27:05 (在此[簡報錄音](https://my.adobeconnect.com/p7th2gf8k43)中)。
