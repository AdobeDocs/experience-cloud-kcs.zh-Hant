---
title: 最佳化  [!DNL Dispatcher]  快取
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/20/2021 7:12:29 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 1:45:44 PM
version-number: 1
article-number: KA-17458
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ee6e74a7-d931-ec11-b6e5-000d3a5ba97a
exl-id: 84871fce-d53d-4a1d-aabf-ccf8c8c47810
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1411'
ht-degree: 100%

---

# 最佳化 [!DNL Dispatcher] 快取

## 說明


本文主要介紹 AEM Dispatcher 中的最新最佳化以及如何將這些最佳化發揮到極致。AEM Dispatcher 是一種快取[反向 Proxy](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server)伺服器，旨在和 Adobe Experience Manager 一起搭配使用。  可將其當成現有網頁伺服器軟體中的模組來安裝和執行。  在撰寫本文時，[dispatcher 模組受到支援](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-install.html) (在 [!DNL Apache HTTP Server]、Microsoft IIS 和 [!DNL iPlanet] 上)。


## 解析度

<br><br>Dispatcher 快取的運作原理<br><br><br><br><br><br>
在最基本的層面上，AEM Dispatcher 是一種反向 Proxy，會透過執行快取、快取排清和快取失效來運作。

如需有關 Dispatcher 的更多詳細資訊，請參閱相關連結：

1. [Dispatcher 運作原理以及如何進行安裝](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher.html).
2. [Dispatcher 中可用的設定選項](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html).
3. [有關 Dispatcher 運作原理的網路研討會](https://github.com/cqsupport/webinar-dispatchercache)- 請注意，簡報中的某些資訊會根據舊版本的 Dispatcher。
4. [有關 Dispatcher 功能、CDN 使用和安全性的 Gems 網路研討會](https://docs.adobe.com/ddc/en/gems/dispatcher-caching---new-features-and-optimizations.html)。
5. [有關 Dispatcher 中新功能的 Gems 工作階段 (v4.1.9 之後)](https://helpx.adobe.com/tw/experience-manager/kt/eseminars/gems/aem-dispatcher.html)。

<br><br><br><br><br><br>最佳化 Dispatcher 快取<br><br><br><br><br><br>
以下是一些最佳化 Dispatcher 快取的方法：

1. <b>快取幾乎所有內容</b>- 這表示快取使用者多次請求的任何內容。
2. <b>快取不同時段的個人化內容</b> - 如果您的網站有個人化內容，則請考慮在您的 AEM 應用程式中使用 [[!DNL Apache Sling Dynamic Includes]](https://helpx.adobe.com/tw/experience-manager/kt/platform-repository/using/sling-dynamic-include-technical-video-setup.html) 以利用 [!DNL Ajax] (瀏覽器層級的不同步 JavaScript 和 XML 呼叫)、SSI (網頁伺服器層級的伺服器端包含) 和 ESI (CDN 層級的邊緣端包含) 來快取不同時段的不同頁面部分。
3. <b>絕不刪除即時 Dispatcher 上的 Dispatcher</b> - 如果 Dispatcher 正在提供即時內容並且您刪除了快取，這將導致大量請求返回 AEM。  因此，絕不應該在即時 Dispatcher 上刪除 Dispatcher 快取。
4. <b>裝填緩存</b> - 刪除 [!DNL Dispatcher] 快取之前，先從負載平衡器拿掉 [!DNL Dispatcher]，刪除快取，然後執行 Web 編目程式工具以在 Dispatcher 上快取檔案，然後再將其放在負載平衡器上。
5. <b>快取錯誤頁面</b> - 利用<b>[DispatcherPassError 1](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer)</b> ([!DNL Apache] 網頁伺服器特定) 指令從 Dispatcher 快取中提供錯誤頁面，例如 404。
6. <b>GZip 會壓縮所有檔案類型，預先壓縮的檔案除外</b> - 在 [!DNL Apache] 網頁伺服器中可使用 [ mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html)，但請確保未設定 <b>`Vary: User-Agent`</b> 標題<b></b>。在 Microsoft IIS 中，請使用[動態壓縮](https://docs.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/)。

   [!DNL Apache] 設定範例 (僅指定特定內容類型以避免預先壓縮檔案類型)：

   `AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript`
7. <b>啟用 [/serveStaleOnError](https://helpx.adobe.com/tw/experience-manager/kb/ServeStaleContentOnError.html)</b> (在 `/cache` 設定中) - 當 AEM 執行個體出現錯誤時提供舊快取檔案。
8. <b>新增 [/gracePeriod](https://docs.adobe.com/content/help/zh-Hant/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> 至 `/cache` 設定 - 定義在最後一個內容發佈事件 (「啟動」) 之後仍可以從快取中提供過期、自動失效的資源的秒數。  這減少了在大型內容發佈活動 (例如「樹啟動」) 期間返回發佈執行個體的請求數量。
9. <b>將規則新增到 [/ignoreUrlParams](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b> - 忽略應用程式不需要或不使用的查詢字串參數。  即使存在查詢字串，這也允許快取 URL。
10. <b>快取 Cache-Control 和 Last-Modified 回應標題</b> - 使用<b>[/headers](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> 設定來快取 HTTP 回應標題 <b>`Cache-Control`</b> 和 <b>`Last-Modified`</b> (和/或 <b>`ETag`</b> 標題，若從 AEM 傳送)。  這有助於在 CDN 和瀏覽器層面簡化和最佳化快取。  快取這些標題使得只有 AEM 可設定標題，網頁伺服器本身則不行。  請注意，執行此操作時，您需要開始從 AEM 應用程式傳送標題。
11. <b>快取內容的時間盡可能拉長</b>並<b>減少返回 AEM 的請求</b> - 透過在所有排清代理程式上啟用[重新取得](https://helpx.adobe.com/tw/experience-manager/kb/optimizing-the-dispatcher-cache.html#refetching-flush)排清，將排清請求最佳化。  或使用 [<b>/enableTTL</b>](https://helpx.adobe.com/tw/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) 並設定 <b>`Cache-Control: max-age=...`</b> 標題，以將快取檔案的時間盡可能拉長。  請參閱[下文](https://helpx.adobe.com/tw/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls)以了解有關本主題的詳細資訊。


<br><br><br><br><br><br>使用 TTLs<br><br><br><br><br><br>
截至 [!DNL Dispatcher] 版本 4.1.11，[/enableTTL 1](https://helpx.adobe.com/tw/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL) 可在 `.any` 檔案設定中設定。  本設定使得 Dispatcher 採用在 HTTP `Cache-Control` 回應標題中設定的快取有效期。  換句話說，Dispatcher 的功能將類似 CDN，當檔案到期時會發生主要形式的快取失效。  一旦您實現了這個並對所有來自 AEM 的回應開始傳送 <b>`Cache-Control: max-age=...`</b>，您就可以在發佈執行個體中安全地停用 Dispatcher Flush 代理程式。

在發佈執行個體上停用排清代理程式後，您可能仍希望能夠排清 Dispatcher 快取。  在這種情況下，您可以使用 [ACS Commons - Dispatcher Flush UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。  此工具可安裝在作者執行個體上。  它為使用者提供了一個 UI，他們可以在其中執行手動快取排清請求。

<b>I. 啟用 TTL (「存留時間」或有效期) 樣式失效的步驟：</b>

1. 修改 AEM 應用程式中的原始程式碼以對尚未設定原始程式碼的所有請求傳送 <b>`Cache-Control`</b> 標題和 <b>`Last-Modified`</b>。
2. 安裝 [!DNL Dispatcher] 4.1.11 或更高版本。
3. 設定 <b>[/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> (位於網站的 `.any` 陣列設定中)。
4. 設定 <b>[/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>設定，以快取 <b>`Cache-Control`</b> and <b>`Last-Modified`</b> 標題。
5. 重新啟動網頁伺服器。


<b>II. 在發佈執行個體上停用 Dispatcher Flush 代理程式：</b>

Dispatcher 現在將使用 `Cache-Control` 標題來控制快取檔案的失效。  既然是這種情況，則不再需要從發佈執行個體中排清 Dispatcher。

1. 前往每個發佈執行個體上的 `/etc/replication/agents.publish.html`。
2. 前往每個排清代理程式的設定並停用該代理程式。


<b>III. 允許來自作者執行個體的手動 Dispatcher Flush 請求：</b>

由於已停用排清代理程式，您將完全依賴 <b>`Cache-Control`</b> 標題來控制何時在 Dispatcher 上重新整理內容。  您仍然可以允許使用者核發 Dispatcher 快取的手動排清：

1. 在作者執行個體上安裝 [ACS Commons - Dispatcher Flush UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html)。
2. 在作者執行個體上設定排清代理程式。
3. 在每個代理程式設定中，設定<b>觸發器</b> = <b>忽略預設值</b>選項為已啟用。此選項會使得排清代理程式忽略使用者何時在 AEM UI 中按一下 <b>(取消) 發佈</b>或者<b> (取消) 啟動</b>。

<br><br><br><br><br><br>重新擷取 Dispatcher Flush<br><br><br><br><br><br>
為了最佳化 Dispatcher Flush 請求，所有 Dispatcher Flush 代理程式都應該啟用稱為重新擷取排清的功能。

若要啟用重新擷取 Dispatcher Flush，請執行以下操作：

1. 前往 <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> 並以管理員身分登入。
2. 從[此處](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true)下載套件。
3. 將套件上傳並安裝到封裝管理員。
4. 前往 Dispatcher Flush 代理程式設定。例如 <b>/etc/replication/agents.author/flush.html</b>
5. 按一下<b>[!UICONTROL 編輯]</b>。
6. 設定以下內容
   - <b>序列化類型</b> = <b>重新擷取 Dispatcher Flush</b>
   - <b>已擴充的</b> = <b>HTTP 方法</b> = <b>POST</b>
7. 按一下<b>[!UICONTROL 儲存]</b>。


請注意，上面安裝的套件只是一個基本範例。  若要自訂和最佳化重新擷取排清，您可以修改它傳送的 URI 清單。  程式碼是開放原始碼，並可以在[此處](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle)找到。  該程式碼將 URI 清單當成參數新增到請求內文中，告知 Dispatcher 要重新擷取哪些路徑。  您可以根據應用程式要求新增更多路徑，以最佳化網站的快取功能。
<br><br><br><br><br><br>重新擷取排清的更詳細說明<br><br><br><br><br><br>
通常，Dispatcher Flush 會透過刪除檔案來運作：

1. 觸碰 `.stat` 檔案
2. 刪除 `/content/foo.\*`
3. 刪除 `/content/foo/_jcr_content`


由於在步驟 2 中刪除檔案，下次使用者請求 `/content/foo.html` 或者 `/content/foo.json` 之類的檔案時，當「重新擷取」檔案時，隨後也將對同一檔案的請求傳送到發佈執行個體，直到已快取檔案。  對於緩慢回應或高流量的頁面 (例如首頁頁面)，這可能會導致溢出發佈執行個體層。

若要解決此問題，請啟用 Dispatcher 的一項稱為重新擷取的功能。  此功能允許您傳送 Dispatcher 應主動「重新擷取」並取代而不是刪除的 URI 清單。

如需它如何運作以及如何設定的示範，請參閱 22:41-27:05 (在此[簡報錄音](https://my.adobeconnect.com/p7th2gf8k43)中)。
