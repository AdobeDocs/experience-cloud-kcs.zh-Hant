---
title: "優化AEM站點快取"
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS，優化AEM站點快取， "
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Nayanika Chakravarty
article-created-date: "5/23/2023 7:21:02 PM"
article-published-by: Nayanika Chakravarty
article-published-date: "5/23/2023 8:52:26 PM"
version-number: 6
article-number: KA-17461
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=88b246f3-9ef9-ed11-8849-6045bd006b4b"
source-git-commit: 4560c99baaf493e24789ccc5899eeda9c10638fb
workflow-type: tm+mt
source-wordcount: '1853'
ht-degree: 4%

---

# 優化AEM站點快取

## 說明 {#description}

<b>環境</b>
Adobe Experience Manager


<b>問題/症狀</b>
優化您的體AEM系結構中的快取是獲得大效能提升的最快方法之一。  本文重點介紹如何優化體系結構中可用的各種緩AEM存。

<b>體AEM系結構和快取</b>

在所有體AEM系結構中，用戶訪問站點時會遇到多個快取層。  標準體系結構中需要考慮4個緩AEM存層。  這包括Web瀏覽器、CDN、Dispatcher和實AEM例。
![screpton_2018-03-25160541](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/optimizing-aem-site-caches/jcr:content/main-pars/image/screenshot_2018-03-25160541.png "screpton_2018-03-25160541")

## 解決方法 {#resolution}


<u><b>瀏覽器快取</b></u>



用戶在重複訪問您的站點時遇到的第一級快取是其自己的瀏覽器。  通常通過 [<b>快取控制：最大值=...</b>](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) 響應 [標題](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)。  的 <b>最大年齡</b> 設定告訴瀏覽器在嘗試「重新驗證」或再次從站點請求檔案之前，應快取檔案的秒數。  快取的概念 <b>最大年齡</b> 通常稱為「快取過期」或TTL（「生存時間」）。

在 <b>快取控制</b> 影響快取發生方式的標頭。  以下是一些常見指令：

1. &#x200B;<b>私 </b>- <b>私</b> 的 <b>快取控制</b> 頭使檔案僅在瀏覽器中快取，而不在CDN等中間快取中快取。  本指令的實際用途是，您的頁面包含個性化/用戶特定的內容。 



   使用範例：

   <b>  </b><b>快取控制：max-age=300，私有</b>
2. <b>S&#x200B;最大值 </b>- <b>S最大值 </b>的 <b>快取控制</b> 標頭允許您為共用快取（如CDN）設定不同的TTL。  設定此值後，瀏覽器將使用中設定的內容 <b>最大年齡</b> 而其他暗藏者會尊重 <b>S最大值</b> 的子菜單。



   使用範例：

   <b>快取控制：max-age=600,s-maxage=300</b>


現代瀏覽器都支援 <b>快取控制</b> 但是，HTTP/1.0中存在一些舊的不建議使用的標頭，這些標頭可能仍會對快取產生影響。  這些標題是 <b>[過期](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Expires)</b> 和 <b>[普拉格馬](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Pragma)</b>。  如果您不需要支援非常舊的瀏覽器，則不發送這些響應報頭。
除了快取外，重新驗證也是一個重要概念。  重新驗證依賴於 <b>[上次修改時間](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified) </b>([響應](https://developer.mozilla.org/en-US/docs/Glossary/Response_header))/<b> [If-Modified-Sine](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Modified-Since)</b> ([請求](https://developer.mozilla.org/en-US/docs/Glossary/Request_header))標題， <b>[ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag)</b> （響應）/ <b>[無匹配](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match)</b> （請求）標題。

瀏覽器測試時的警告：

在GoogleChrome中測試快取時，如果您通過https進行測試，並且您擁有自簽名證書，則不會快取任何內容。  如果證書不可信或無效，Chrome將不快取響應或執行重新驗證。

有關調度程式的說明：

Dispatcher v4.2.3和早期版本AEM存在問題， <b>/enableTTL</b> 僅快取 <b>最大年齡</b> 指令。  這意味著即使 <b>私</b> 或 <b>S最大值</b> 指令設定為，如果 <b>最大年齡</b> 的子菜單。  此問題在Dispatcher 4.2.4和更高版本中得到解決。





<u><b>CDN快取</b></u>



A [CDN或「內容交付網路」](https://en.wikipedia.org/wiki/Content_delivery_network)，是一個分佈式網路，由Web伺服器組成，旨在從離用戶最近的位置快取和提供內容。  這減少了網路跳數和從用戶電腦到內容的距離，從而減少了 [&quot;往返時間&quot;(RTT)](https://en.wikipedia.org/wiki/Round-trip_delay_time)。  RTT是瀏覽器向您的站點發送請求並接收響應所花的時間。  CDN提供商空間的競爭使得CDN非常經濟。  這樣，您就可以輕鬆決定為站點使用CDN。  <b>如果您尚未使用CDN，則您肯定應將CDN合併到您的站點中。</b>

CDN提供商很多，每個提供商都提供不同的功能和配置。

<b>CDN快取如何工作？</b>

CDN按照與瀏覽器類似的規則快取內容。  他們依賴 <b>[快取控制](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) </b>HTTP [響應](https://developer.mozilla.org/en-US/docs/Glossary/Response_header) 頭部，通常會退回到 <b>[過期](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Expires)</b> 標題 <b>快取控制</b> 找到標題。

大多數CDN提供了觸發手動刷新快取的某種方法。  在許多情況下，快取刷新在傳播到擁有檔案的所有邊緣伺服器方面會有延遲（例如15分鐘）。

<b>優化CDN使用</b>

要確保您在CDN中以最佳方式快取檔案，需要做以下幾件事：

1. 使用支援 <b>過時重新驗證 </b>和 <b>失效 — if-error</b> 指令 <b>快取控制 </b>標題。

   - <b>過時重新驗證</b>  — 此指令指示CDN在快取檔案過期後檢索新版本時，為舊版本（已快取）提供服務。
   - <b>失效 — if-error</b>  — 類似地，當源在重新驗證過程中出現錯誤時，此指令會告訴CDN為舊（已快取）版本的檔案提供服務。
2. GZip壓縮所有未預壓縮的檔案類型的響應。
您應該從調度程式級別執行此操作。  這將確保減少發送到CDN的位元組數。  CDN通常按傳輸的位元組計費，因此壓縮響應降低了成本。


- 在Dispatcher級別上啟用GZip壓縮：Apache — 使用 [mod_defla](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html)。  請注意mod_deflate使用「變異」。  在某些情況下， Vary標頭可能導致CDN和瀏覽器完全跳過快取。
- MicrosoftIIS — 使用 [動態壓縮](https://docs.microsoft.com/zh-tw/iis/configuration/system.webserver/httpcompression/)。
- 不允許對已壓縮的大檔案或檔案進行gzip壓縮。  請注意，大多數影像和視頻格式已經預壓縮。  在Web伺服器級別即時壓縮它們會帶來極高的效能成本。

   - 在Apache上，可以通過AddOutputFilterByType指令執行此操作：

      AddOutputFilterByType DEFLATE文本/html文本/純文字檔案/xml文本/css文本/javascript應用程式/javascript
   - 在IIS上，可以通過 [`<` 動態類型`>`  配置](https://docs.microsoft.com/zh-tw/iis/configuration/system.webserver/httpcompression/)。
- 如果您的CDN提供程式支援 [邊緣側包括](https://en.wikipedia.org/wiki/Edge_Side_Includes) (ESI)，然後利用此功能。 使用AEMESI可以拆分元件。 為此，請使用Apache `[` 吊具動態包括`]` (https://github.com/Cognifide/Sling-Dynamic-Include)或實施自定義解決方案。 如果您有相當靜態的頁面，但是您正在頁面的幾個部分中提供更多動態內容，則此功能非常有用。 在這些情況下，您實際上將頁面拆分為多個CDN檔案。 這樣，您就可以在不同時間段快取頁面的不同部分。


<b>流行的CDN提供程式</b>

下面列出了一些流行的CDN提供程式：

- [Microsoft Azure CDN](https://docs.microsoft.com/en-us/azure/cdn/cdn-overview)
- [Amazon雲鋒](https://aws.amazon.com/cloudfront/)
- [Akamai](https://www.akamai.com/tw/zh)
- [Google雲CDN](https://cloud.google.com/cdn/docs/)
- [機架空間CDN](https://www.rackspace.com/en-us/cloud/cdn-content-delivery-network)
- [最大CDN](https://www.stackpath.com/maxcdn/)
- [雲閃](https://www.cloudflare.com/cdn/)
- [快速](https://www.fastly.com/)
- [F5網路CDN](https://f5.com/glossary/content-delivery-network-cdn)


還有幾個，每個都有不同的特徵。

<b>注意：</b>

小心 [變化](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Vary) 響應標頭。  在某些情況下， <b>變化</b> 可能導致CDN和瀏覽器完全跳過快取。  作為一般經驗，請避免添加 <b>變化</b> 除 <b>變化：接受編碼 </b>（僅在響應壓縮時應用）。  換句話說，如果需要「改變」響應的輸出，請使用其他URL。

例如，如果移動HTML與案頭的版本不同，則使用不同的URL。  這將使CDN和瀏覽器能夠更有效地快取。

<u><b>調度AEM器快取</b></u>



如果CDN快取已過期，則請求將到達調度程AEM序快取。  在此級別上，可以執行許多操作來優化快取。

因為這是一個較大的主題，請參見 [這篇文章](https://helpx.adobe.com/mt/experience-manager/kb/cache-problems-on-chrome-with-SSL-certificate-errors.html) 有關如何優化調度程式快取的詳細資訊。

<b>AEM發佈實例</b>


在級AEM別上，需要執行以下幾項操作來優化各個快取層：
1. 設定以下HTTP響應標頭，這些標頭未按預設AEM設定設定。

   1. <b>[快取控制：最大值=...](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) </b> — 要設定此標題， [ACS共用 — Dispatcher TTL](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-ttl/index.html) 可以使用，也可以實施自定義代碼來設定。
   2. <b>[上次修改時間](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified) </b> — 如果頁面內容相對靜態，如文章，則可以將其上次修改的標題設定為cq:lastModified date/time（上次修改文章時間）。  但是，如果頁面是動態的，且元件內容中包含JCR查詢結果，則最好將其設定為使用當前日期/時間。
   3. <b>[ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag) </b> — 如果您決定使用它，而不是 <b>上次修改時間</b>你可以寫 [ReplicationEventListener](https://helpx.adobe.com/experience-manager/using/replication_events.html) 它偵聽頁面激活並生成頁面內容的md5哈希。  可以將此設定為作者實例上頁面的jcr:content節點上的屬性。  複製頁面時，會將其發送到發佈實例。  對於內容相對靜態的頁面元件，這可以正常工作，但是如果該頁面在某種程度上是動態的或引用了大量內容，則必須省略（或計算）ETag。
2. 如果站點具有個性化/動態內容：

   1. 使用 [Apache Sling動態包括](https://helpx.adobe.com/tw/experience-manager/kt/platform-repository/using/sling-dynamic-include-technical-video-setup.html) 將內容分解，以便可以在不同時間段內快取頁面的不同部分。

      1. 快取可通過以下技術完成：

         1. CDN上的邊緣端包括(ESI)
         2. Web伺服器上的伺服器端包括(SSI)
         3. 或者，瀏覽器上的非同步JavascriptAJAX和XML()
      2. 可以將頁面上的元件分解為可快取不同時間段的單獨請求。  頁面中相對靜態的部分可以快取更長的時間段。
   2. 考慮使用 [ACS公域的HTTP快取功能](https://adobe-consulting-services.github.io/acs-aem-commons/features/http-cache/index.html)。
3. 優化客戶端庫。

   1. [啟用精簡](https://helpx.adobe.com/experience-manager/6-3/sites/developing/using/clientlibs.html) 在客戶端庫上。
   2. 如果客戶端庫中的檔案已預微型化，則禁用該客戶端庫上的微型化。  編輯cq:ClientLibraryFolder節點：

      1. 設定屬性 <b>js處理器</b> 字串類型`[` `]`  值 <b>分鐘：無</b>
      2. 和set屬性 <b>css處理器</b> 字串類型`[` `]`  值 <b>分鐘：無</b>
      3. 查看更多詳細資訊， [這裡](https://helpx.adobe.com/experience-manager/kb/how-to-change-the-minification-engine-for-client-libraries-in-AEM.html)。
   3. [嵌入客戶端](https://helpx.adobe.com/experience-manager/6-3/sites/developing/using/clientlibs.html)[庫](https://helpx.adobe.com/experience-manager/6-3/sites/developing/using/clientlibs.html) 來精簡和減少js和css檔案。
   4. 實施 [ACS公域中版本控制的客戶端](https://adobe-consulting-services.github.io/acs-aem-commons/features/versioned-clientlibs/index.html) 允許CDN和Dispatcher將js和css檔案快取較長的時間段。

