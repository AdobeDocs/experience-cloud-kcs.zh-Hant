---
title: 基於Wireshark的SMPP協定分析
description: 說明
solution: Campaign
product: Campaign
applies-to: Campaign Classic
keywords: KCS、SMPP、Wireshark
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Craig Thonis
article-created-date: 5/6/2022 3:51:03 PM
article-published-by: Craig Thonis
article-published-date: 5/6/2022 3:52:19 PM
version-number: 4
article-number: KA-17506
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=9319e64e-54cd-ec11-a7b5-6045bd00d4f5
exl-id: 39c89da2-36ae-4c66-9553-cfc3d5b4003a
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '2545'
ht-degree: 1%

---

# 基於Wireshark的SMPP協定分析

## 說明

<br>了解如何使用Wireshark分析SMPP流量。<br><br><br><br><br>簡介<br><br><br><br> <br><br>
大多數高吞吐量SMS-C與SMPP協定3.4版相容。此協定允許發送SMS並接收有關這些SMS的傳送的資訊。 SMPP協定記錄在SMPP協定規範v3.4中，該規範在Internet上作為PDF文檔提供。

本文不能替代本說明：它提供了解釋協定規範並將其與Wireshark顯示器匹配的實用提示，以幫助解決Adobe Campaign與SMS-C合作夥伴之間的問題。

由於SMPP協定包含了許多不同的部分，所以不同的SMS-C之間有差異。

疑難排解問題時，請一律聯絡SMS-C合作夥伴以取得資訊或協助您仔細檢查收到的內容。 如果SMS-C回覆有錯誤，您的SMS-C合作夥伴將是最能告訴您為何其回覆有錯誤的最佳人選。 如果您使用SMPP模擬器而非連線至實際的SMS-C，則應使用原始碼（或除錯程式）來了解發生的情況。


## 解析度

<br><br>在不使用Wireshark的情況下捕獲網路流量<br><br><br><br><br><br>
如果您沒有直接存取電腦的權限，則可能需要使用命令列工具(例如 *tcpdump*. 如果已知連接的TCP埠，請放置正確的過濾器以避免捕獲所有通信。 以下是捕獲埠12345的示例tcpdump命令行 <b>outfile.pcap</b>:


| `tcpdump -i any -w outfile.pcap tcp port 12345` |
| --- |


檔案 <b>outfile.pcap</b> 然後在Wireshark中開啟以供進一步分析。


<br><br>Wireshark處理<br><br><br><br> <br><br><br><br>
本主題假設您熟悉Wireshark的基本知識：捕獲資料包，定義簡單過濾器，讀取資料包詳細資訊。 以下提供簡要介紹： [howtogeek — 如何使用Wireshark捕獲、過濾和Inspect資料包](https://www.howtogeek.com/104278/how-to-use-wireshark-to-capture-filter-and-inspect-packets/).

要過濾Wireshark中的SMPP流量，有三個重要功能：

- 在SMS-C的埠上使用顯示篩選器。例如，如果SMS-C使用埠10000，請使用下列篩選器：
   *tcp.port == 10000*


要按電話號碼或按文本內容隔離資料包，請使用具有以下設定的搜索功能：
![smpp1](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image/smpp1.png "smpp1")
- 使用 <b>跟蹤TCP流</b> 工具來隔離您正在處理的資料流。
關閉彈出的紅色/藍色文本窗口，因為它只對與SMPP無關的文本協定有用。
   ![smpp2](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_964579199/smpp2.png "smpp2")



<br><br><br><br>SMPP協定<br><br> <br><br>
該協定通過TCP工作，且是完全二進位的，這意味著需要Wireshark（或十六進位編輯器）等特殊工具才能解密流的內容。

資料流由獨立PDU組成：每個PDU都是一條消息，其中包含一個命令、一個狀態、一個序列號以及基於該命令的其他資訊。

由於TCP作為流協定的性質，TCP資料包可能包含多個PDU,PDU可能跨越2個或多個TCP資料包。 Wireshark將正確地重新組裝PDU，因此對Wireshark用戶來說，它大多是透明的。

以下是在發送MT後接收SR時通過網路的PDU的示例：
![smpp3](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_388497282/smpp3.png "smpp3")
注意：

在SMPP規範（SMPP命令集）的5.1.2.1節中可找到標準命令清單。
<br><br><br><br><br><br>SMPP回應<br><br><br><br> <br><br>
SMPP協定要求響應PDU確認所有命令：

BIND_TRANSMITTER已被確認 *BIND_TRANSMITTER_RESP*, *SUBMIT_SM* 確認 *SUBMIT_SM_RESP*、等

回應有逾時，通常為10、30或60秒。回應可能包含正確認(command _status = 0)或錯誤（請參閱5.1.3） *command_status*, *表5-2* （在SMPP規範中）。 大多數情況下，這些回應都會立即執行，且未達到回應逾時。

請務必區分SMPP回應錯誤和SR錯誤代碼：在響應錯誤或SR錯誤欄位中，同一錯誤代碼可能表示不同的內容。 在報告錯誤代碼時，您必須非常小心找到錯誤代碼的位置，因為值的含義取決於其上下文。
<br><br><br><br><br><br>SMPP連接初始化<br><br><br><br><br><br>
SMPP連接通過使用TCP連接開始。 然後，由促銷活動發送BIND操作，由BIND RESP確認。 這些操作在SMPP規範（BIND操作）的第4.1節中進行了描述。
![smpp4](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_468626174/smpp4.png "smpp4")
綁定操作執行登錄/密碼檢查並交換有關平台名稱、版本和規範中描述的其他欄位的資訊。

注意:

可在system_id欄位中找到登錄。



在Campaign中，您應會看到 *BIND_TRANSMITTER* 啟動MT傳輸和 *BIND_RECEIVER* 封包 *nlsm* 觸發MO/SR連線。

<b>發送器、接收機和收發器： </b>用於Campaign Classic的SMPP連接器在單獨的發送器/接收器模式下工作：有兩個TCP連接，一個用於發送MT，另一個用於接收MO和SR。 請注意，TCP連接始終由Campaign啟動，即使是接收方模式。

SMPP還提供收發模式，但此模式未在SMPP連接器中實現以進行Campaign Classic。

SMPP連接器並行使用多個連接來傳輸MT。 由於連接器的設計方式，無法控制此值。
<br><br><br><br><br><br>接收MO<br><br><br><br><br><br>
接收者被綁定時，SMS-C可隨時發送MO。 MO是使用 *DELIVER_SM* 位數為2-5的PDU *esm_class* 清晰(通常 *esm_class* 將僅為0)。
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_695769115/smpp5.png "smpp5")
此 *DELIVER_SM* PDU必須由 *DELIVER_SM_RESP* 具有相同PDU *sequence_number*.
<br><br><br><br><br><br>發送MT<br><br><br><br><br><br>
要發送MT，必須成功綁定發射器。 在執行其他任何操作之前，請檢查綁定過程是否已成功執行。

MT會以 *SUBMIT_SM* PDU。 SMS-C應快速回覆 *SUBMIT_SM_RESP* PDU:此回應封包特別，因為它包含SMS-C資料庫中訊息的ID（在與SMS-C合作夥伴通話時一律包含此ID，以協助他更快找到訊息）。 此ID將存在於SR中，是匹配MT與其對應SR的唯一方法。

欄位 *registered_delivery* （在規範5.2.17節中描述）向SMS-C指示是否為該特定MT請求SR。 如果您沒有收到特定訊息的SR，請檢查欄位是否已正確設定於 *SUBMIT_SM* PDU。
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1891077095/smpp5.png "smpp5")<br><br><br><br><br><br>MT編碼<br><br><br><br><br><br>
注意：

SMS編碼是複雜的主題，包含許多陷阱和各種實施。


<br><br><br><br> <br><br>
如有編碼問題，請一律聯絡SMS-C合作夥伴，以利執行正確作法。 您的SMS合作夥伴對於支援的編碼和特殊規則有深入的了解，這些可能會因其技術平台的限制而套用。 讓他們檢查您向他們發送的內容以及他們向您發送的內容，這是成功且穩定的互聯的唯一途徑。

SMS訊息使用特殊的7位元編碼，通常稱為GSM7編碼。 請參閱Wikipedia GSM 03.38（英文）。
<br><br><br><br> <br><br>
在SMPP通訊協定中，GSM7文字將擴充至每字元8位元，以便疑難排解。 SMS-C會先將其封裝為每個字元7位元，再傳送至行動裝置。 這表示SMS的short_message欄位在SMPP幀中長度可達160個位元組，而在行動網路上發送時，其長度限制為140個位元組（最顯著的位被簡單地丟棄）。

若有編碼問題，請檢查下列重要事項：

- 首先，請確定您知道哪些字元屬於哪個編碼。 GSM7因部分支援變音標籤（重音）而臭名昭著。 特別是在法語中，在法語中，é和è是GSM7的一部分，但ê, — 或ï不是。 西班牙語的情況也好不到哪裡去。
- C與Cedilla(ç)只存在於GSM7字母表的大寫，但有些手機會以小寫或「智慧」大小寫呈現：一般建議是完全避免，並移除cedilla（法文仍可讀）或切換至UCS-2。
- 除非SMS-C合作夥伴明確要求，否則請勿在SMS中使用ASCII:此編碼會浪費空間，因為它具有8位字元，且覆蓋率小於GSM7。
- Latin-1並不總是受支援：嘗試使用Latin-1之前，請先檢查與SMS-C合作夥伴的相容性。
- Adobe Campaign Classic連接器不支援國家語言班次表。 您必須改用UCS-2。
- UCS-2和UTF-16通常由手機混合。 這是傳送表情符號，以及UCS-2中未出現的其他常用字元時的問題。
- Wireshark不支援GSM7編碼：特殊字元的顯示不正確。 如果您需要檢查GSM7字串是否正確編碼，則必須將十六進位代碼與GSM7表進行比較。


此 *data_coding* 欄位會告訴您使用的編碼。 唯一的問題是，值0表示規格中的預設SMS-C編碼，但一般來說是指GSM7。 查看SMS-C *合作夥伴與data_coding關聯的編碼= 0(Adobe Campaign僅支援GSM7進行data_coding* = 0)。

訊息的最大大小取決於其編碼。 下表匯總了所有相關資訊：
<br><br><br><br> <br>

| 編碼 | data_coding | 訊息大小（字元）  | 多部分SMS的部件大小  | 可用字元  |
| --- | --- | --- | --- | --- |
| GSM7 | 0 | 160 | 152 | [GSM7基本字元集+擴充功能](https://en.wikipedia.org/wiki/GSM_03.38) （延伸字元為2個字元）  |
| 拉丁文–1  | 3 | 140 | 134 | ISO-8859-1 |
| UCS-2 UTF-16  | 8 | 70 | 67 | Unicode（因電話而異） |

<br><br><br><br><br>使用者資料標題(UDH)<br><br><br><br><br><br>
UDH（使用者資料標題）是新增至SMS文字的小型二進位標題。 它們可觸發SMS串連、國家語言班次表、標誌/影像（很少使用）或WAP推播等特殊功能。

由於UDH是文字欄位（short_message SMPP欄位）的一部分，因此它縮短了SMS的有效大小。 例如，串連的SMS UDH將使每個SMS部分佔用6個位元組（即6個實際8位元組，而非7位字元），為每個訊息部分僅留下152個7位字元的空間。

維基百科提供關於使用者資料標題和串連簡訊（英文）的好文章。

要了解short_message是否包含UDH，請檢查esm_class的位6和7（請參閱規範的5.2.12節）。 Wireshark在介面中剖析UDH，並給出準確的資訊。
![smpp7](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_738682084/smpp7.png "smpp7")
在上面的螢幕截圖中，您可以在消息欄位(1)中看到用戶資料標頭、UDH(2)中包含的資訊以及一些不屬於資料包但由Wireshark(3)計算的額外資訊：簡訊正文欄位特別有趣，因為它包含由Wireshark重新組合的完整消息。
<br><br><br><br><br><br>接收SR<br><br><br><br><br><br>
當接收機綁定時，SMS-C可以隨時發送SR。 SR使用DELIVER_SM PDU發送，位為2-5 *esm_class*設定。
![smpp8](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_158644074/smpp8.png "smpp8")
此 *DELIVER_SM* PDU必須由 *DELIVER_SM_RESP* 具有相同PDU *sequence_number*. 要查找與此SR匹配的MT，請搜索 *SUBMIT_SM_RESP* 使用相同的ID。 例如，這是與SR匹配的MT:
![smpp9](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1012110897/smpp9.png "smpp9")
只有在 *registered_delivery* 欄位在MT中設定。

注意:

Adobe Campaign Classic SMPP連接器不會處理在 *SUBMIT_SM_RESP* 封包。 規範不明確禁止此行為，但被視為不良行為（這表示訊息在傳送前即已接收）。 如果您太常遇到此案例，請要求您的SMS-C合作夥伴修正其平台。
<br><br><br><br><br><br>破譯SR的short_message欄位<br><br><br><br><br><br>
SR PDU的文本欄位具有SMPP協定規範附錄B中描述的特殊編碼。 不幸的是，儘管大多數SMS-C或多或少地遵守這種格式，但這種格式只是建議，不是協定的一部分。

您應直接向SMS-C合作夥伴索取其自身實作的檔案，並仔細檢查其是否符合您在Wireshark中看到的內容。 SMS-C實作者甚至不知道其實作，這經常會導致問題和誤解。 如果對此欄位有任何疑問（尤其是錯誤碼），請務必向SMS-C合作夥伴尋求協助。

基本格式如下：

*id:IIIIIIII子：SSS dlvrd:DDD提交日期：YYMMDDHMMdone日期：YYMMDDHMMstat:DDDDDDD錯誤：EEE*

*文字:........*

以下是閱讀上述文字的一般准則：

- id與中已傳送的相同 *SUBMIT_SM_RESP*&#x200B;匹配MT。
- 您可以忽略文本欄位中的問題：此欄位會由Campaign忽略，因為此欄位無用、不可靠，而且如果SMS是使用純英數字ASCII以外的其他編碼傳送，甚至可能完全無法讀取。 這是正常行為。
- 欄位名稱不區分大小寫(例如id:子：文字：也可注明為ID:子：文字：)。
- 此 *dlvrd*&#x200B;欄位通常不可靠，除非SMS-C合作夥伴有記錄。
- 日期可能有任何時區，因此幾乎毫無用處，或者因為遠程伺服器的時鐘關閉而完全錯誤。
- 此 *stat*&#x200B;欄位可能有附錄B中定義的其他值。使用常識和SMSC合作夥伴的文檔來了解其含義。
- 此 *er*&#x200B;欄位完全取決於SMS-C，而SMS-C合作夥伴記錄的大部分時間。 代碼000通常表示成功，而其他任何代碼表示錯誤。 欄位通常為數值，但也可以是十六進位。

<br><br><br><br><br><br>同一MT的多個SR<br><br><br><br><br><br>
某些SMS-C為同一MT發送多個SR以跟蹤網路中MT的進展。 這大多是無用的，因為大多數時候客戶只想知道消息何時被接收（這通常是最後一個SR）。

當有疑問時，僅處理從SMS-C接收的最新SR以查找消息的狀態。
<br><br><br><br><br><br>SMPP窗口<br><br><br><br><br><br>
由於操作和響應是非同步的，因此您可以在等待響應之前發送多個操作PDU來優化傳輸速率。 未回覆的訊息數稱為視窗。

最大窗口為4的傳輸示例：
![smpp10](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_2072040949/smpp10.png "smpp10")
目前的實施無法控制視窗，並預期遠端SMS-C的速度足以處理MT。
