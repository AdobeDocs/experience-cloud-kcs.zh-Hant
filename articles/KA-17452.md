---
title: "從JVM獲取線程轉儲"
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: 「KCS」
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 6:41:42 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 6:48:01 PM"
version-number: 1
article-number: KA-17452
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=2e54c459-d531-ec11-b6e5-000d3a5ba97a"
exl-id: 9ad0fefe-b974-45d9-95b6-4a90f691f0cb
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1052'
ht-degree: 0%

---

# 從JVM取用執行緒轉儲

## 說明

<br><br><br>如何從上的JVM取得執行緒轉儲 [!DNL Linux]、 UNIX或 [!DNL Windows]?<br><br><br><br> <br><br>
線程轉儲是所有 [!DNL Java] 當前活動於 [!DNL Java Virtual Machine] (JVM)。

從JVM獲取線程轉儲有幾種方法。 強烈建議採用超過1個線程轉儲。 最好的做法是以常規間隔取用10個線程轉儲（例如，每10秒一個線程轉儲）。


## 解析度

<br><br>步驟1:取得 [!DNL Java] 過程<br><br><br><br> <br><br>
獲取線程轉儲所需的第一條資訊是 [!DNL Java] 程式的PID。

此 [!DNL Java] JDK隨jps命令一起提供，該命令列出所有 [!DNL Java] 程式id。 您可以像這樣運行此命令：


```
jps -l 70660 sun.tools.jps.Jps 70305
```


<b>注意：</b> 在 [!DNL Linux] 和UNIX，您可能必須以 `sudo -u user jps -l`，其中「user」是 [!DNL Java] 進程正以的形式運行。

如果這行不通，或者您仍找不到 [!DNL Java] 進程，(未設定路徑，未安裝JDK或更舊 [!DNL Java] 版本)，使用

- UNIX, [!DNL Linux]，和Mac OS X: `ps -el | grep java`
- [!DNL Windows]：按Ctrl+Shift+Esc開啟任務管理器，並查找 [!DNL Java] 過程

<br><br><br><br><br><br>步驟2:從JVM請求線程轉儲<br><br><br><br><br><br><br><br>
<b>jstack</b>

如果已安裝/可用，建議使用 <b>jstack</b> 工具。 它會將執行緒轉儲打印到命令行控制台。

要使用jstack獲取線程轉儲，請運行以下命令：
`jstack -l pid`

您可以使用控制台輸出重定向/附加指令將連續線程轉儲輸出到檔案：
`jstack -l pid  threaddumps.log`

附註:

- 自JDK 1.5起（適用於上的JVM），即可使用jstack工具 [!DNL Windows]，則只適用於某些版本的JDK 1.5和JDK 1.6)。
- jstack即使有效 `-Xrs` 已啟用jvm參數
- 無法使用JDK 1.6中的jstack工具從JDK 1.5上運行的進程中提取線程轉儲。
- 在 [!DNL Linux] 和UNIX，您需要以擁有java進程的用戶身份運行該命令：

   `sudo -u *java-user* jstack -l *pid*`  

   (java-user應取代為 [!DNL Java] 進程以運行方式運行)
- 在 [!DNL Windows]，如果運行jstack並獲得「沒有足夠的儲存空間可用於處理此命令」錯誤，則必須以windows SYSTEM用戶或擁有java進程的用戶身份運行jstack。  您可以使用可下載的psexec來執行此操作 [此處](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx). 要以SYSTEM用戶身份運行jstack，請使用如下命令：

   `psexec -s jstack *pid*   threaddumps.log`

   如果無法在伺服器上安裝psexec，則可以建立包含命令的.bat檔案並運行它 [使用 [!DNL Windows] 任務調度程式（作為不同用戶）](https://technet.microsoft.com/en-us/library/cc748993%28v=ws.11%29.aspx).
- 如果java程式沒有回應，則有時可協助使用選項 <b>`-J-d64`</b> （在64位系統上），例如：

   `jstack -J-d64 -l *pid*  threaddumps.log`
- 如果jstack命令(`jstack -l pid  threaddumps.log`)會擲回下方的錯誤1，然後以擁有java程式的使用者身分執行命令。  例如:

   `sudo -u sling jstack -l pid  threaddumps.log`



<br><br><br><br><br><br> <br><br><br><br>

```
Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

sun.jvm.hotspot.debugger.linux.LinuxDebuggerLocal$LinuxDebuggerLocalWorkerThread.run(LinuxDebuggerLocal.java:138)
```



<br><br>JSTACK指令碼<br><br>
這是 [指令碼](https://github.com/cqsupport/jstackSeries.sh/blob/master/jstackSeries.sh) (與上的 [eclipse.org](http://wiki.eclipse.org/How_to_report_a_deadlock#jstackSeries_--_jstack_sampling_in_fixed_time_intervals_.28tested_on_Linux.29))，會使用jstack取用一系列執行緒傾印。  它還使用top命令獲取線程級cpu的使用量。

就這樣運行：
`sudo -u *user*jstackSeries.sh *pid* *aemserveruser* *count* *delay*`

例如︰`sudo -u aemuser jstackSeries.sh 1234 aemserveruser 10 3`

- <b>1234</b> 是的pid [!DNL Java] 過程
- <b>cq5serveruser</b> 是 [!DNL Linux] 或UNIX用戶 [!DNL Java] 進程以
- <b>10</b> 是執行緒傾放的數量
- <b>3</b> 是每個轉儲之間的延遲


<b>注意： </b>頂端輸出具有十進位格式的本機線程id，而jstack輸出具有十六進位格式的nid。  通過將線程ID轉換為十六進位，可以將從頂部輸出到jstack輸出的高cpu線程進行匹配。

除了上述指令碼外，我們也有類似的 [[!DNL Windows] Powershell指令碼和github上的AdobeAEM特定指令碼](https://github.com/cqsupport/jstackSeries.sh).

<b>適用於Adobe Experience Manager的執行緒傾印工具</b>

如果您使用Adobe Experience Manager產品，則可安裝 [此工具](https://helpx.adobe.com/experience-manager/kb/thread-dumps-collection-analysis.html) 以擁有簡單的UI來產生執行緒傾印。
<br><br>獲取線程轉儲的替代方法<br><br>
若 <b>jstack</b> 工具無法供您使用，則您可以取用執行緒傾印，如下所示：

<b>注意：</b> 如果命令行參數為，某些工具無法從JVM獲取線程轉儲 `-Xrs` 啟用。 如果您在處理線程轉儲時遇到問題，請查看是否啟用了此選項。
<br><br>UNIX、Mac OS X和 [!DNL Linux] （JDK 1.4或更新版本）<br><br>
在UNIX、Mac OS X和 [!DNL Linux]，您可以將QUIT訊號傳送至 [!DNL Java] 指示它將線程轉儲輸出到標準輸出的過程。

1. 運行以下命令以執行此操作：

   `kill -QUIT *pid*`

   您可能需要以 `sudo -u user kill -QUIT *pid*` 其中，「user」是 [!DNL Java] 進程正以的形式運行。
2. 如果您使用 `crx-quickstart/server/start` 指令碼，然後您的線程轉儲將輸出到 `crx-quickstart/server/logs/startup.log`. 如果您使用第三方應用程式伺服器，例如JBoss, [!DNL WebSphere], [!DNL Tomcat]或者，請參閱伺服器的檔案，以了解標準輸出要導向的檔案。

[!DNL Windows]:<br><br>JDK 1.X
1. 下載javadump.exe（附於下方）。
2. 使用以下三個引數啟動JVM（它們的順序必須正確）:

   `-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput -XX:LogFile=*C:\temp\jvmoutput.log*`
3. 按Ctrl+Shift+Esc鍵開啟「任務管理器」。
4. 尋找 [!DNL Java] 程式。
5. 從命令列執行

   `javadump.exe *pid*`
6. 執行緒傾印會出現在 `jvmoutput.log` 檔案。

<br><br>JDK 1.6<br><br>
從獲取線程轉儲 <b>jconsole</b> 工具，使用外掛程式：0

以下是如何請求線程轉儲：

1. 將以下參數添加到運行的jvm `Communique` : `-Dcom.sun.management.jmxremote`
2. 下載並安裝JDK 1.6（如果尚未完成）。
3. 下載並解壓縮 [線程轉儲分析器實用程式](https://github.com/irockel/tda). 1
4. 執行 `jconsole.exe` (JDK 1.6):

                               `jconsole.exe -pluginpath /path/to/file/tda.jar`
5. 按一下 <b>線程轉儲</b> 標籤。
6. 按一下 <b>請求線程轉儲</b> 連結。

<b>注意：</b> 如果您執行的是AEM 6。\*並要觀察正在運行的線程，可以請求 `http://host:port/system/console/status-Threads` 來獲取線程清單。 但是，請注意，這些線程轉儲不能用於線程轉儲分析工具，如武士或tda。<br><br>套用至<br><br>
JVM中運行的所有Adobe產品
<br><br>線程轉儲分析工具：<br><br>
0 [http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)
1  [https://github.com/irockel/tda](https://github.com/irockel/tda)
2 [https://fastthread.io/](https://fastthread.io/)
3 [https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm](https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm)
