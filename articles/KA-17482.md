---
title: "分析記憶體問題"
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/21/2021 5:18:56 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/21/2021 5:21:24 PM"
version-number: 1
article-number: KA-17482
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ef6bccf5-9232-ec11-b6e5-000d3a5ba97a"
exl-id: 48e49bcc-3d49-464e-8af9-e4292b1d6899
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '866'
ht-degree: 1%

---

# 分析記憶體問題

## 說明

<br>症狀<br><br>
此 [!DNL Java] 應用程式執行速度較慢，最終記憶體不足，或在記錄或主控台輸出中出現錯誤 `OutOfMemoryError: Java heap space` 或 `OutOfMemoryError: gc overhead limit exceeded`.
<br><br>原因<br><br>
這種問題可能有很多原因。

一個可能的原因是 [!DNL Java] 應用程式，在本例中， CRX / CQ是從命令行啟動的，該命令行具有的預設堆記憶體設定為 [!DNL Java]. 這表示jvm參數 `-Xmx` 未指定。 CRX或CQ需要至少分配256 MB的堆才能運行。 如果出現此問題，請從命令行開始，確保已設定堆記憶體設定。 範例：


```
java -Xmx512m -jar *.jar
```


如果情況並非如此，則您的應用程式可能會保留太多對象，而不釋放這些對象以用於垃圾收集。 這叫記憶體洩漏，請參閱 [此處](http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html) 以取得更多資訊。 請參閱以下章節，了解如何分析Java應用程式中的記憶體問題。


## 解析度

建立堆轉儲<br><br>自動生成堆轉儲<br><br>
要在記憶體不足時自動建立堆轉儲，可以添加jvm參數 `-XX:+HeapDumpOnOutOfMemoryError` 當應用程式擲回 `OutOfMemoryError`. 例如，


```
java -Xmx256m -XX:+HeapDumpOnOutOfMemoryError -jar *.jar
```


這會生成堆轉儲檔案(`java_...hprof`)，只要 `java` 進程記憶體不足。 生成堆轉儲後，該進程可以繼續運行。 通常，一個堆轉儲檔案就足以分析問題。

<b>注意：</b> 如果您使用 `crx-quickstart/server/start` 指令碼來啟動您的CRX例項，然後您可以新增 `-XX:+HeapDumpOnOutOfMemoryError` 到 `CQ_JVM_OPTS` 變數（請確定變數也未加上註解）。 例如：


```
CQ_JVM_OPTS='-XX:+HeapDumpOnOutOfMemoryError'
```


新增此參數並重新啟動CRX例項後，請確認已設定新的jvm選項。 執行 `ps -ef | grep java` 從命令列。 然後檢查您是否看到 `-XX:+HeapDumpOnOutOfMemoryError` 作為CRX的參數 `java` 程式。

如果由於磁碟空間限制而需要指定其他目錄來生成堆轉儲，則可以添加 `-XX:HeapDumpPath=/path/to/generate/heapdump` 參數，指示jvm將檔案放在何處。

請參閱 [此處](http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions) ，以獲取調試相關jvm參數的參考資訊。
<br><br>手動生成堆轉儲<br><br>
<b>[!DNL Sun]/OracleJVM</b>

要手動生成堆轉儲，請運行此命令(可在 `bin` jdk主目錄的資料夾):

1. 查找pid `java` 正在為生成堆轉儲的進程。
   - 在 [!DNL Unix] 或 [!DNL Linux] 這可以透過 `ps -ef | grep java` 或 `jps -l`
   - 在 [!DNL Windows] 這可以通過開啟任務管理器，按 `Ctrl+Shift+Esc` 然後前往 <b>檢視</b> = <b>選擇列</b> = <b>PID（進程標識符）</b> 或 `jps -l`
2. 執行下方的jmap命令，取代 `/path/to/generate/heapdumpfile.hprof` 用要生成堆轉儲檔案的位置替換 `1234` 上一步查的pid。

   ```
   jmap -dump:format=b,file=/path/to/generate/heapdumpfile.hprof 1234
   ```


<b>IBM JVM</b>

首先，必須更改有關轉儲代理的預設JVM設定，才能對用戶信號生成正確的轉儲。 有幾種垃圾堆，但通常需要滿的 <b>系統轉儲</b> 進行徹底的記憶體分析。 新增下列引數：

<b>Xdump:heap:opts=PHD+CLASSIC:events=user -Xdump:system:events=user</b>

當JVM收到SIGQUIT時，會發生此「使用者」事件([!DNL Linux]、AIX®、z/OS®和i5/OS™)或SIGBREAK([!DNL Windows])來自作業系統的訊號。

有關詳細資訊，請參閱供應商的文檔 [此處](http://pic.dhe.ibm.com/infocenter/java7sdk/v7r0/index.jsp?topic=%2Fcom.ibm.java.aix.70.doc%2Fdiag%2Fpreface%2Fchanges_70%2Foverview_gc.html).

<b>警告：</b> 堆轉儲檔案很大，可以與最大堆大小相同的磁碟大小 `-Xmx` jvm參數配置。 請確保為生成轉儲檔案的目錄分配了足夠的磁碟空間。
<br><br>分析堆轉儲<br><br>
分析堆轉儲的好工具是 [!DNL Eclipse] MAT([!DNL Eclipse Memory Analyzer]): [http://www.eclipse.org/mat/](http://www.eclipse.org/mat/)

此工具無法分析 <b>IBM JVM</b> 產生的轉儲。 對於這些，有幾種可能性。 [IBM HeapAnalyzer](https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091) 對於PHD或傳統格式的堆轉儲效果良好。

要獲得完整的系統轉儲分析，請使用 [IBM支援助理工作台](http://www-01.ibm.com/software/support/isa/) ，使用 [IBM Monitoring and Diagnostic Tools for Java - Memory Analyzer 1.2版](http://www.ibm.com/developerworks/java/jdk/tools/memoryanalyzer/) 安裝於頂端。
<br><br>堆直方圖<br><br>
堆直方圖是對每個使用的即時對象和記憶體數量的簡單測量 [!DNL Java] 類別。 很可惜，根據 [!DNL Java] 安裝時，所需工具可能無法使用或不一定能運作。 若要建立堆直方圖，首先需要的進程ID為 [!DNL Java] 程式。 要得到它，快跑 `ps` 或（如果可用），請執行：


```
jps -l
```


此 [!DNL Java] 工具會取得所有執行中的程式id [!DNL Java] 程式。 範例：


```
327 
3332 sun.tools.jps.Jps
3313 crx-quickstart-....jar
```


現在，執行下列命令：


```
jmap -histo 3313
```


清單按所需的總記憶體排序(淺：排除引用的對象)。 前20行輸出最有趣。 輸出示例：


```
JVM version is 1.5.0_20-141
Iterating over heap. This may take a while...
Warning: skipping invalid TLAB for thread t@62211
Warning: skipping invalid TLAB for thread t@62467
...
SizeCountClass description
-------------------------------------------------------
1059290412916byte
1028584075255* ConstMethodKlass
628317658388char
604230414928int
4995752116201* SymbolKlass
422089675255* MethodKlass
41965126969* ConstantPoolKlass
29285606969* InstanceKlassKlass
26310086066* ConstantPoolCacheKlass
2395872149742org.apache.jackrabbit.core.query.lucene.DocId$PlainDocId
14760087003java.util.HashMap$Entry
139612858172java.lang.String
107023244593java.util.HashMap$Entry
75398410036short
73546454org.apache.jackrabbit.core.query.lucene.DocId
7201927502java.lang.Class
64070413348com.day.crx.persistence.tar.index.IndexEntry
...
```


<b>其他資訊</b>

為了幫助分析問題，我們還需要了解以下資訊：

- CRX或CQ版本，包括所有已安裝Hotfix版本號碼的清單。
- 作業系統、JVM供應商和版本。


<b>參考</b>

1 [http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html](http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html)
2 [http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions](http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions)
