---
title: 如何疑難排解AEM中的SAML相關問題
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/21/2021 5:02:47 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 2:33:40 PM
version-number: 1
article-number: KA-17476
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=55a54eb6-9032-ec11-b6e5-000d3a5ba97a
exl-id: f7cf029d-bc42-4180-8746-63b012b7e9ff
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '411'
ht-degree: 1%

---

# 如何疑難排解AEM中的SAML相關問題

## 說明

如何疑難排解AEM的SAML相關問題？疑難排解需要哪些資訊？

## 解析度


<b>無限循環問題：</b>

- 檢查 `ds:signature` 是SAML聲明的一部分若非如此，則需在IDP端完成此操作，並勾選已簽署聲明的核取方塊
- 在SAML回應中檢查nameId格式，格式應與SAML設定中設定的nameId原則格式完全相符
- 在SAML回應中檢查SAML AudienceRestriction，此標籤的值應與SAML設定中的實體ID完全相符
- 檢查 `saml2:conditions(NotBefore & NotOnOrAfter)`，伺服器未與ntp伺服器同步。請使用ntpd並強制它同步系統時間(`ntpdate -s pool.ntp.org`)。 對於測試，將時鐘容差更改為–1，這將忽略時鐘差。
- 檢查IDP是否未簽署聲明。 要求IDP團隊簽署回應，並依照SAML規格簽署聲明。
- 檢查IDP的斷言是否已加密，SAML追蹤器是否會輸出。 如果是，SAML驗證處理常式的設定應使用加密核取方塊


<b>檢查SAML憑證格式是否正確：</b>

- 從SAML回應擷取簽章，並修正憑證，亦即在第65行後，按Enter鍵，依此類推。
- 接著，這可用來安裝在AEM truststore中，並與IDP比對憑證詳細資訊。


<b>加密:</b>

- 首先，請一律完成SAML設定，而不需加密。 完成此操作後，啟用加密。 使用這種方式可輕鬆除錯問題


<b>Dispatcher:</b>

- 請確定篩選器區段中允許SAML登入請求。否則請更新 `/filter` 區段，允許POST要求 `\*/saml_login`.



   `/0100 { /type "allow" /method "POST" /url "\*/saml_login" }`


- 檢查 `Mod` header()`mod_header`)，在 `httpd.conf`。格式應為以下

   `Header always edit Set-Cookie (.\*) "$1; HTTPOnly; Secure"`


<b>無效斷言：</b>
<br><br><br><br><br> <br><br> <br><br><br><br>

| 1<br>  2 | `com.adobe.granite.auth.saml.model.Assertion Invalid Assertion: Signature invalid.` `com.adobe.granite.auth.saml.SamlAuthenticationHandler Private key of SP not provided: Cannot sign Authn request` |
| --- | --- |


- 可能與儲存在信任存放區中的憑證有關。 解決方案可能是刪除並重新上傳新 `idp_cert` 並檢查使用案例。
- 如果您未加密SAML回應，可忽略「未提供SP的私密金鑰：無法簽名Authn請求」錯誤。


<b>無法檢索私鑰：</b>
<br><br><br><br><br> <br><br> <br><br><br><br>

| 1<br>  2 | `com.adobe.granite.security.user.internal.servlets.KeyStoreManagingServlet,1121, javax.servlet.Servlet ServiceEvent REGISTERED` `saml.log:27.01.2019 14:16:13.642 *ERROR* qtp275633701-179 com.adobe.granite.auth.saml.SamlAuthenticationHandler KeyStore uninitialized. Cannot retrieve private key to decrypt assertions.` |
| --- | --- |

 
- 此錯誤表示IDP已加密宣告，且沒有私密金鑰可解密回應。 如果要加密回應，需要在AEM金鑰存放區中上傳有效的私密金鑰。

<br><br><br><br> <br><br>
<b>提出SAML相關支援票證時要提供的資訊：</b>

- SAML要求
- SAML回應
- SAML設定
- SAML的除錯記錄(`com.adobe.granite.auth.saml`)
- `Error.log`
- 擷取SAML請求/回應的HAR1檔案


1https://help.tenderapp.com/kb/troubleshooting-your-tender-site/generating-an-har-file
