---
title: "錯誤：開啟的檔案太多"
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '732'
ht-degree: 1%

---

# 錯誤：開啟的檔案太多

## 說明

<br><br><br>問題<br><br><br><br><br><br>
記錄檔包含「檔案太多」錯誤，而AEM未回應。
<br><br><br><br><br><br>原因<br><br><br><br><br><br>
原因是兩種可能性之一：

- 應用程式在使用檔案或套接字之後沒有關閉資源（如檔案或套接字）。
- 或者，應用程式需要的開啟檔案比進程允許的檔案多。



## 解析度

<br><br> <br><br><br><br><br><br>
解決此問題的方法是：

1. 了解導致達到開啟檔案限制的原因
2. 增加限制或修正應用程式錯誤。

<br><br><br><br>查找哪些檔案或套接字已開啟<br><br> <br><br>
\*\*請注意，開啟檔案限制適用於合併的開啟檔案、管道和套接字的總數，而不僅適用於檔案。

在Linux平台上，lsof命令可用於調試進程所開啟的資源。

以下是收集有用輸出清單的範例指令碼：
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6<br>  7<br>  8<br>  9<br>  10<br>  11<br>  12<br>  13<br>  14<br>  15<br>  16<br>  17<br>  18<br>  19<br>  20<br>  21 | `#!/bin/bash``if` `$``# -eq 0``  ``then``    ``echo` `"No PID specified"``    ``echo` `"Run command with PID, for example:"``    ``echo` `"lsof-script.sh 12345"``    ``exit` `2``fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID``lsof``-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt | ``wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt |``awk` `'{print $9}'` `|``sed` `-e``"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(repository/index\).*$/\1\2/"` `|``sed` `-e``"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/lib\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/logs\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/ext\).*$/\1\2/"` `|``sort` `|``uniq` `-c |``sort` `-rn -k1``lsof``-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"``lsof` `|``wc` `-l` |
| --- | --- |

<br><br><br><br><br> <br><br>
示例輸出：
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6 | `$ ./lsof-script.sh 18070``Files open by the process:``    ``1995``Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt``Total open files in OS:``   ``18399` |
| --- | --- |

<br><br><br><br><br> <br><br>
Inspect產生的lsof-sorted-counts-\*.txt檔案的輸出。  它顯示進程當前保持開啟的檔案或套接字。

如果發現列出的開啟套接字或檔案不應仍然開啟，則很可能是由於應用程式錯誤。  更新應用程式代碼以在使用檔案和套接字後關閉它們。

延遲開放通訊端的常見原因是自訂程式碼，用以提供Web服務。  在許多情況下，會使用Apache Commons HttpClient等程式庫，但開發人員絕不會關閉連線。  請參閱 [這篇文章](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) 有關Apache Commons HttpClient的詳細資訊。
<br><br><br><br> <br><br>提高殼層會話的限制<br><br><br><br> <br><br>
檢查用戶的最大開啟檔案數限制，然後以AEM進程作為運行方式的同一用戶運行以下內容：

ulimit -Sn ulimit -Hn

使用AEM/CQ的預設開始指令碼時，請執行下列動作以增加限制：

1. 開啟crx-quickstart/bin/start以進行編輯
2. 將變數CQ_MAX_OPEN_FILES新增至指令碼頂端：CQ_MAX_OPEN_FILES=8192匯出CQ_MAX_OPEN_FILES


如果看到錯誤「 — bash:上限：開啟檔案：無法修改限制：不允許操作」，則上述設定無法運作。

請改為增加/etc/security/limits.conf中的限制。 如需如何重新設定使用者限制的詳細資訊，請參閱下方。

如果您使用第三方應用程式伺服器，例如JBoss或Websphere，請遵循以下各節，並使用供應商的文檔進行驗證。

注意:

如果本文中的配置均未解決問題，請使用命令lsof -p查看哪些檔案已開啟。（ — p是有問題的進程的進程id。） 可能是您的應用程式將檔案控點保持開啟。 如果您發現控點大多由AEM保管，而非您的應用程式，請聯絡支援。


<br><br><br><br> <br><br>提高使用者的限制<br><br><br><br> <br><br>
要更改非根用戶開啟檔案的最大數量，請更改檔案/etc/security/limits.conf。 您可以根據每個使用者設定限制：

crx_process_username軟nofile 8092

crx_process_username硬通訊檔案20000

注意:

此設定要等到使用者下次登入時才會生效。


<br><br><br><br> <br><br>提高系統限制<br><br><br><br> <br><br>
有時，用戶限制已足夠高，但系統本身已達到其最大檔案數。 以su/root用戶身份運行以下內容：

1. 檢查作業系統上最大開啟檔案設定(如果低於20000，則增加此設定是合理的)。    cat /proc/sys/fs/file-max
2. 將此行添加到/etc/sysctl.conf以增加系統開啟檔案的最大值：fs.file-max = 300000
3. 運行以下命令：sysctl -p
4. 驗證運行以下命令時顯示新值：cat /proc/sys/fs/file-max


注意:

此設定要等到使用者下次登入時才會生效。


<br><br><br><br> <br><br>其他資訊<br><br><br><br> <br><br>
當系統或用戶使用其最大檔案句柄數時，將發生此錯誤。

下載
[取得檔案](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>可用於監視開啟的檔案使用情況的殼層指令碼。 只有在「開啟的檔案過多」錯誤持續存在時，才使用此指令碼，即使您增加了最大值。 或者，如果您懷疑CRX或您的應用程式正在將檔案控點保留為開啟狀態，則可以使用它。 使用指令碼之前，請設定下列變數：JAVA_HOME、QUICKSTART_PATH、OUTPUT_DIR、USER、MAX_FILES_THRESHOLD。 若要使用指令碼，請將其設定為cron工作。
