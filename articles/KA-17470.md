---
title: '"錯誤：開啟的檔案太多 | AEM'
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS,AEM錯誤，檔案太多"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Victoria Barnato
article-created-date: "5/17/2023 1:46:53 AM"
article-published-by: Victoria Barnato
article-published-date: "5/17/2023 1:50:16 AM"
version-number: 7
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=286f81b1-54f4-ed11-8848-6045bd006ce9"
source-git-commit: f46170b620af53bc7afa1364d3e563b15b0fbb55
workflow-type: tm+mt
source-wordcount: '614'
ht-degree: 38%

---

# 錯誤：開啟的檔案太多 | AEM

## 說明 {#description}

<b>環境</b>
Adobe Experience Manager


<b>問題/症狀</b>
日誌檔案包含錯誤「*檔案太多* 和Adobe Experience Manager(AEM)沒有回應。




## 解決方法 {#resolution}


解決此問題的方法是：

1. 找出導致達到開啟檔案上限的原因
2. 可增加上限或者修復應用程式錯誤。


<b>A.查找哪些檔案或套接字處於未開啟狀態</b>

注意 — 開啟檔案限制適用於合併的開啟檔案、管道和套接字的總數，而不只是檔案。

在Linux平台上， <b>開啟的檔案清單</b> (`lsof`)命令可用於調試進程所開啟的資源。

以下是收集實用資訊的範例指令碼 `lsof` 輸出：


```
#!/bin/bash
if `[`  $# -eq 0 `]` 
  then
    echo "No PID specified"
    echo "Run command with PID, for example:"
    echo "lsof-script.sh 12345"
    exit 2
fi
 
JAVA_PROCESS_PID=$1
 
lsof -p $JAVA_PROCESS_PID `>`  lsof-output-$JAVA_PROCESS_PID.txt
 
echo "Files open by the process:"
cat lsof-output-$JAVA_PROCESS_PID.txt |  wc -l
 
echo "Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"
cat lsof-output-$JAVA_PROCESS_PID.txt | awk '{print $9}' | sed -e "s/\(.*\)\(segmentstore\).*$/\1\2/" |  sed -e "s/\(.*\)\(repository`[` /`]` index\).*$/\1\2/" | sed -e "s/\(.*\)\(felix`[` /`]` bundle\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` lib\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` logs\).*$/\1\2/" |  sed -e "s/\(.*\)\(`[` /`]` ext\).*$/\1\2/" | sort | uniq -c | sort -rn -k1 `>`  lsof-sorted-counts-$JAVA_PROCESS_PID.txt
 
echo "Total open files in OS:"
lsof | wc -l
```


<u>範例輸出</u>:


```
$`>`  ./lsof-script.sh 18070
Files open by the process:
    1995
Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt
Total open files in OS:
   18399
```


Inspect產生的輸出 `lsof-sorted-counts-*.txt` 檔案。 這會顯示流程目前保持開啟的檔案或通訊端。

如果您發現列出的開啟套接字或檔案不應仍然開啟，則可能是由於應用程式錯誤。 更新應用程式代碼以在使用檔案和套接字後關閉它們。

造成持續開啟的通訊端的一個常見原因是建立 Web 服務的自訂程式碼。在許多情況下，資料庫（例如Apache Commons） `HttpClient` ，但開發人員絕不會關閉連線。 請參閱 [這篇文章](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) 如需Apache Commons的詳細資訊 `HttpClient`.

<b>B.提高殼層會話的限制</b>

檢查用戶的最大開啟檔案數限制，然後以AEM進程作為運行方式的同一用戶運行以下內容：

`ulimit -Sn ulimit -Hn`

使用 AEM/CQ 的預設開始指令碼時，請執行以下操作以增加上限：

1. 開啟 `crx-quickstart/bin/start` 進行編輯
2. 將變數 `CQ_MAX_OPEN_FILES` 新增到指令碼的頂端：`CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


如果啟動 AEM 時看到錯誤 `-bash: ulimit: open files: cannot modify limit: Operation not permitted`，則上述設定即不會運作。

反之，有必要增加 `/etc/security/limits.conf` 中的上限。如需有關如何重新設定使用者上限的詳細資訊，請參閱下文。

如果您使用第三方應用程式伺服器，例如JBoss或Websphere，請遵循以下各節，並使用供應商的文檔進行驗證。

注意：如果本文中的任何配置都未解決問題，則使用命令查看哪些檔案已開啟 `lsof -p` （ — p是有問題進程的進程id）。 可能是您的應用程式使得檔案控制代碼處於開啟狀態。如果您發現這些控制代碼主要由 AEM 而不是您的應用程式持有，請和支援人員聯絡。

<b>C.增加用戶的限制</b>

要更改非根用戶開啟的檔案的最大數量，請更改 `file/etc/security/limits.conf`. 您可以為每個使用者設定上限：

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

注意：此設定在使用者下次登入時才會生效。

<b>D.增加系統限制</b>

有時，用戶限制已足夠高，但系統本身已達到其最大檔案數。 以su/root用戶身份運行以下內容：

1. 檢查作業系統上的最大開啟檔案設定 (如果低於 20000，則增加此設定是有意義的)。
   `cat /proc/sys/fs/file-max`
2. 將此行添加到/etc/sysctl.conf以增加系統開啟檔案的最大值：
   `fs.file-max = 300000`
3. 執行此命令：
   `sysctl -p`
4. 驗證執行以下命令時是否會顯示新值：
   `cat /proc/sys/fs/file-max`


注意：此設定要等到使用者下次登入時才會生效。

<b>原因</b>

原因是兩種可能性之一：

- 應用程式在使用檔案或通訊端等資源後沒有將其關閉。
- 或者應用程式需要比流程允許的更多開啟的檔案。


<b>其他資訊</b>

當系統或用戶使用其最大檔案句柄數時，將發生此錯誤。

您也可以執行下列動作：

1. 以管理員使用者身分登入http://localhost:4502/crxde 。
2. 瀏覽至 `/libs/granite/monitoring/config`
3. 以滑鼠右鍵按一下並刪除 `/libs/granite/monitoring/config`
4. 按一下「儲存全部」。 重新啟動CQ。

