---
title: 「錯誤：開啟的檔案過多」
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: 「KCS」
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '641'
ht-degree: 100%

---

# 錯誤：開啟的檔案過多

## 說明

<br><br><br>問題<br><br><br><br><br><br>
記錄檔包含錯誤：「檔案過多」，並且 AEM 沒有回應。
<br><br><br><br><br><br>原因<br><br><br><br><br><br>
原因是以下兩種可能性之一：

- 應用程式在使用檔案或通訊端等資源後沒有將其關閉。
- 或者應用程式需要比流程允許的更多開啟的檔案。



## 解析度

<br><br><br><br><br><br><br><br>
這個問題的解決方案是：

1. 找出導致達到開啟檔案上限的原因
2. 可增加上限或者修復應用程式錯誤。

<br><br><br><br>查找哪些檔案或通訊端保持開啟狀態<br><br><br><br>
\*\* 請注意，開啟檔案上限適用於開啟的檔案、垂直號和通訊端合併的總數，而不僅僅是檔案。

在 [!DNL Linux] 平台`lsof`上，命令可用於對流程保持哪些資源開啟進行偵錯。

這是一個範例指令碼，可收集有用的`lsof`輸出：<br><br><br><br><br><br><br><br><br>

```
#!/bin/bash` `if` `$` `# -eq 0` `  ` `then` `    ` `echo` `"No PID specified"` `    ` `echo` `"Run command with PID, for example:"` `    ` `echo` `"lsof-script.sh 12345"` `    ` `exit` `2` `fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID` `lsof` `-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt | ` `wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt |` `awk` `'{print $9}'` `|` `sed` `-e` `"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(repository/index\).*$/\1\2/"` `|` `sed` `-e` `"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/lib\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/logs\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/ext\).*$/\1\2/"` `|` `sort` `|` `uniq` `-c |` `sort` `-rn -k1` `lsof` `-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"` `lsof` `|` `wc` `-l` 
```


<br><br><br><br><br> <br><br>
範例輸出：<br><br><br><br><br> <br><br><br><br>

```
 $ ./lsof-script.sh 18070 Files open by the process:      1995 Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt Total open files in OS:     18399 
```

<br><br><br><br><br><br><br>
檢查產生的 `lsof-sorted-counts-\*.txt` 個檔案的輸出。 這會顯示流程目前保持開啟的檔案或通訊端。

如果您發現清單中開啟的通訊端或檔案不應仍然開啟，則可能是由於應用程式錯誤。  更新您的應用程式程式碼以在使用檔案和通訊端後將其關閉。

造成持續開啟的通訊端的一個常見原因是建立 Web 服務的自訂程式碼。在許多情況下，已使用 [!DNL Apache][!DNL Commons HttpClient] 之類的資料庫，但開發人員卻永遠不會關閉連線。  請參閱[本文](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it)以了解有關 [!DNL Apache][!DNL Commons HttpClient] 的詳細資訊。
<br><br><br><br><br><br>增加殼層工作階段的上限<br><br><br><br><br><br>
請檢查使用者對開啟檔案的最大上限，然後以和 AEM 流程相同的使用者身分執行以下命令：

`ulimit -Sn ulimit -Hn`

使用 AEM/CQ 的預設開始指令碼時，請執行以下操作以增加上限：

1. 開啟 `crx-quickstart/bin/start` 進行編輯
2. 將變數 `CQ_MAX_OPEN_FILES` 新增到指令碼的頂端：`CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


如果啟動 AEM 時看到錯誤 `-bash: ulimit: open files: cannot modify limit: Operation not permitted`，則上述設定即不會運作。

反之，有必要增加 `/etc/security/limits.conf` 中的上限。如需有關如何重新設定使用者上限的詳細資訊，請參閱下文。

如果您使用的是協力廠商應用程式伺服器，例如 [!DNL JBoss] 或者 [!DNL Websphere]，請遵循以下區段並使用供應商的文件進行驗證。

注意：

如果本文中的設定都無法解決問題，則請使用命令 `lsof -p` 查看哪些檔案是開啟的。(`-p` 是有問題的流程的流程 ID。)可能是您的應用程式使得檔案控制代碼處於開啟狀態。如果您發現這些控制代碼主要由 AEM 而不是您的應用程式持有，請和支援人員聯絡。


<br><br><br><br><br><br>增加使用者的上限<br><br><br><br><br><br>
若要變更非根使用者最大開啟檔案數，請變更檔案 `/etc/security/limits.conf`。您可以為每個使用者設定上限：

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

注意：

此設定在使用者下次登入時才會生效。


<br><br><br><br><br><br>增加系統上限<br><br><br><br><br><br>
有時，使用者上限已經夠高，但系統本身卻已達到其最大檔案數。以 `su/root` 使用者的身分執行以下命令：

1. 檢查作業系統上的最大開啟檔案設定 (如果低於 20000，則增加此設定是有意義的)。`cat /proc/sys/fs/file-max`
2. 將此行新增到 `/etc/sysctl.conf` 以增加系統開啟檔案的最大值：`fs.file-max = 300000`
3. 執行此命令：`sysctl -p`
4. 驗證執行以下命令時是否會顯示新值：`cat /proc/sys/fs/file-max`


注意：

此設定在使用者下次登入時才會生效。


<br><br><br><br><br><br>附加資訊<br><br><br><br><br><br>
當系統或使用者使用其最大數量的檔案控制代碼時，會發生此錯誤。

下載
[獲取檔案](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh")<br><br>可用於監視開啟檔案使用情況的殼層指令碼。只有在「開啟的檔案過多」錯誤持續存在時才使用此指令碼，即使您增加了最大值。或者，如果您懷疑 CRX 或您的應用程式造成檔案控制代碼處於開啟狀態，則可以使用它。在使用指令碼之前，請設定以下變數：`JAVA_HOME`、`QUICKSTART_PATH`、`OUTPUT_DIR`、`USER`、`MAX_FILES_THRESHOLD`。若要使用該指令碼，請將其設定為 cron 作業。
