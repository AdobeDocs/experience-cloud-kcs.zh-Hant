---
title: 遷移使用者、群組以及 AEM 執行個體之間的 ACL
description: 說明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: 0f546139887bd42346c58b8aa0ef76015688601c
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 100%

---

# 遷移使用者、群組以及 AEM 執行個體之間的 ACL

## 說明

如何在 AEM 中將具有 ACL 權限的使用者和群組從一台伺服器遷移到另一台伺服器或是從一個 AEM 執行個體遷移到另一個執行個體。

## 解析度

**步驟 1：找到管理員和匿名使用者**

1. 前往 CRXDE 精簡版應用程式 `/crx/de/index.jsp` 並以管理員使用者身分登入 (在來源系統上)。
1. 前往「工具」=「查詢」。
1. 在底部的「查詢」框中，輸入此查詢以查找管理員使用者：*`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. 按一下「執行」並將結果中管理員使用者節點的路徑複製到文字檔案中。
1. 對匿名使用者的查詢重複步驟 3：*`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. 按一下「執行」並將結果中匿名使用者節點的路徑複製到一個文字檔案中 (所以現在您有兩個路徑，一個用於「管理員」，一個用於「匿名」)。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`– 來源系統上的管理員使用者

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib`– 來源系統上的匿名使用者

**步驟 2A：遷移使用者和群組 (使用 `crx2oak` 或者 `oak-upgrade`)**

可以使用 [crx2oak](https://helpx.adobe.com/tw/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) 或者 [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) 工具將使用者和群組在 AEM 執行個體之間遷移。

1. 下載和您正在使用的 Oak 版本相符的 `crx2oak` 或者 `oak-upgrade` jar：
   1. Oak-upgrade：[https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak：[Maven 存放庫](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. 將 jar 檔案上傳至 AEM 伺服器
1. 停止 AEM (來源和目標執行個體)
1. 在下面的命令中替換 jar 檔案的名稱。
1. 將 *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* (在以下命令的 *`--exclude-paths`* 部分參數中) 替換為來自您的來源系統的管理員和匿名使用者的路徑。
1. 在線上修改路徑以和您的執行個體相符 (如有需要，在路徑前新增 *`segment-old:`*，請參閱此處[https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html))：*`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. 然後在伺服器的殼層上執行命令。

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. 完成後，請前往步驟 3 以遷移 ACL。  如果您無法使用 `crx2oak` 遷移，則請改遵循下面的套件遷移步驟進行操作。

**步驟 2B：遷移使用者和群組 (使用套件)**

如果不是透過 LDAP / SAML 身分驗證或是 `CRX2Oak` 自動匯入使用者 (上面的方法 A)，則您可以封裝使用者和群組。  在這種情況下，您將在舊系統上建立兩個單獨的套件 (不包括管理員和匿名的現成可用使用者)。

1. 從上面步驟 1 (「查找管理員和匿名使用者」) 的結果中複製匿名和管理員使用者節點的路徑。

   例如：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv` – 我正在建立套件的系統上的管理員使用者

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib` – 我正在建立套件的系統上的匿名使用者

1. 前往「封裝管理員」*`http://host:port/crx/packmgr/index.jsp`*，並以管理員身分登入。
1. 建立套件「使用者」
1. 將篩選器新增到 `/home/users` 的套件設定，並使用這些排除規則 (在 `/home/users` 篩選器上)：
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. 建置套件。
1. 下載套件。
1. 在您的電腦上解壓縮套件 zip 檔：`jar -xvf users.zip META-INF/vault/filter.xml`
1. 以文字編輯器開啟檔案 `META-INF/vault/filter.xml`。
1. 新增 `mode="merge"` 到篩選器... 標記，例如：

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. 重新壓縮修改後的套件內容，使其包含變更。

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. 建立一個包含篩選規則 `/home/groups` 的「群組」套件。
1. 對群組套件重複步驟 11 至 14。
1. (僅限升級) 如果執行到較新 AEM 版本的遷移，則安裝新的本機 AEM 執行個體 *(屬於舊版本)* (包含 nosamplecontent)，並安裝使用者套件，然後安裝群組套件。然後，在該執行個體上執行就地升級到新版本。這會將使用者轉換為新的 Oak 表示方式。就地升級後，再次重新封裝使用者以將它們移植到您的預期升級執行個體。對使用者群組執行相同的操作。
1. 在新系統上安裝使用者套件。
1. 在新系統上安裝群組套件。
1. 如果您要從較舊的 AEM 版本遷移到 6.3，則請前往 `/useradmin` UI 並將使用者複寫接收者新增到「管理員」群組。

**步驟 3.遷移 ACL**

如果您可以將工具 (ACS Commons) 安裝到 AEM，則請按照以下步驟操作：

1. 下載並安裝 ACS Commons。
1. 按照此處提供的步驟建立 ACL 套件。
1. 前往 http://aem-host:port/crx/packmgr/index.jsp 並以管理員身分登入。
1. 按一下 ACL 套件。
1. 按一下編輯。
1. 選取[!UICONTROL 進階]索引標籤 (請參見下面的螢幕擷圖)。
1. 在 AC 處理下拉式選單中選取[!UICONTROL 合併]，以避免移除目標系統上的現有 ACL。在不同版本的 AEM 之間遷移 ACL 時，這一點尤其重要 (因為它可以避免移除現成可用的 ACL)。

如果您&#x200B;*無法*&#x200B;將工具 (ACS Commons) 安裝到 AEM，則請按照以下步驟操作。請注意，執行這些命令的電腦必須已安裝 Mac OS、[!DNL Linux]、或者 [!DNL Windows] (使用 [!DNL Cygwin]) 和 cURL、[!DNL Python] 以及 [!DNL Java] SDK。

1. 前往 http://src-aem-host:port/crx/packmgr/index.jsp 並以管理員身分登入。
1. 建立一個名為「ACL-migration」的套件
1. 按一下「編輯」按鈕。
1. 選取[!UICONTROL 進階]索引標籤並將 AC 處理模式設定為合併。
1. 儲存。
1. 建置套件並下載。
1. 在檔案系統上對套件執行此命令以擷取 `META-INF/vault/filter.xml` 檔案：

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 在同一目錄中，執行此命令以從來源執行個體下載 `/content` 下 ACL 路徑的 json 檔案 (設定使用者名稱和密碼以及正確的主機)：

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. 建立檔案 `generate-package-filter.py` 並在裡面貼上以下 [!DNL Python] 程式碼：

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. 執行來自建立 data.json 的同一文件夾中的 [!DNL Python] 指令碼並將輸出儲存到 `META-INF/vault/filter.xml` (替換 `filter.xml` 的現有內容)：

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. 使用此命令以更新 zip 檔案中的 `filter.xml`：

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 將 zip 檔案上傳到來源執行個體封裝管理員：http://src-aem-host :port/crx/packmgr/index.jsp
1. 按一下[!UICONTROL 建置]或者[!UICONTROL 重新建置]以建置套建。
1. 從來源 AEM 伺服器下載套件。
1. 將套件上傳到目標 AEM 伺服器的封裝管理員：http://dst-aem-host:port/crx/packmgr/index.jsp
1. 按一下[!UICONTROL 安裝]以進行安裝。
1. 對變更路徑 curl 命令的任何其他路徑重複步驟 8 至 16。例如，這將使 ACL 位於 `/etc` 而不是 `/content`：

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
